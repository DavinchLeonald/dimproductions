<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="preload" href="https://dim.productions/assets/fonts/PressStart2P.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="canonical" href="https://dim.productions/pianovirtuoso18">
  <title>Piano Virtuoso 18</title>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%; overscroll-behavior: none; touch-action: manipulation; -webkit-text-size-adjust: 100%; overflow-x:hidden;}
    body{-webkit-touch-callout:none;-webkit-user-select:none}
    @font-face{
      font-family:'Press Start 2P';
      src:url('https://dim.productions/assets/fonts/PressStart2P.woff2') format('woff2'),
          url('/assets/fonts/PressStart2P.woff2') format('woff2');
      font-style:normal;font-weight:400;font-display:swap;
    }
    body{margin:0;background:#000;color:#fff;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;text-align:center;font-synthesis:none}
    .wrap{max-width:800px;margin:0 auto;padding:16px;overflow-x:hidden}
    h1{font:700 18px/1.2 'Press Start 2P',monospace;margin:6px 0 12px;letter-spacing:.5px}
    #overlay,.big,.segments label{font-family:'Press Start 2P',monospace}
    .card>div:first-child{font-family:'Press Start 2P',monospace;font-weight:700;letter-spacing:.3px}

    .controls{display:flex;flex-direction:column;gap:12px;align-items:center}
    .segments{display:flex;gap:10px}
    .segments label{padding:8px 12px;cursor:pointer;background:transparent}
    .segments input{display:none}
    .segments input:checked+label{background:#b5001e;color:#000}

    .btnRow{display:flex;gap:var(--btn-gap,10px);justify-content:center;flex-wrap:nowrap;align-items:center;overflow:visible;padding:2px 4px}
    @media (max-width:380px){ .btnRow{ flex-wrap: wrap; gap: var(--btn-gap); } }
    button{ padding:0; border:none; background:transparent; cursor:pointer; margin:0; line-height:0; }
    .svgBtn{display:inline-grid;place-items:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
    .svgBtn .icon{width:clamp(var(--btn-icon-min), var(--btn-icon-vw), var(--btn-icon-max));height:auto;transition:filter .25s ease, transform .06s;overflow:visible}
    .svgBtn .icon use{transition:filter .25s ease}
    .svgBtn.pressed .icon{transform:translateY(3px) scale(.98)}

    /* 初期状態: start青く光る, stop消灯 */
    #btnStart .icon{filter:drop-shadow(0 0 10px rgba(0,180,255,.9)) drop-shadow(0 0 25px rgba(0,180,255,.6));}
    #btnStop .icon{filter:none;opacity:0.6}

    /* プレイ中（start押下→stop有効）: stop赤く光り、start消灯 */
    body.playing #btnStart .icon{filter:none;opacity:0.6}
    body.playing #btnStop .icon{filter:drop-shadow(0 0 10px rgba(255,60,60,.9)) drop-shadow(0 0 25px rgba(255,0,0,.6));opacity:1}

    .card{background:#111;padding:10px;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .big{font-weight:700;font-size:20px;line-height:1.1;font-family:'Press Start 2P',monospace}

    #pianoArea{display:flex;justify-content:center;align-items:center;margin:12px auto 18px;max-width:100%;user-select:none;-webkit-user-select:none;touch-action:none;overscroll-behavior:contain;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;}
    #pianoArea svg{display:block;width:clamp(220px,72vw,420px);max-height:38vh;height:auto;margin:0 auto;}
    @media (min-width:768px){#pianoArea svg{width:clamp(360px,70vw,560px);}}
    .spacer-md{height:12px}
    .key{display:flex;align-items:center;justify-content:center;transition:transform .06s ease, filter .06s ease}
    .key.down{transform:translateY(2px) scaleY(.985); filter:brightness(1.15)}
    .glow-black{filter:drop-shadow(0 0 10px rgba(0,0,0,.95)) drop-shadow(0 0 26px rgba(0,0,0,.85)) brightness(.85) contrast(1.1);} 
    .key .label{opacity:.6; font-weight:700}
    .key:active{filter:brightness(1.2)}

    #overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.5);color:#ff5050;font:700 clamp(40px,10vw,120px)/1 'Press Start 2P',monospace;opacity:0;pointer-events:none;transition:.15s;z-index:2147483647;will-change:opacity}
    #overlay.show{opacity:1}

    :root{
      --btn-gap: 10px;
      --btn-icon-min: 220px;
      --btn-icon-vw: 36vw;
      --btn-icon-max: 300px;
    }
  </style>
</head>
<body>
  <!-- Inline SVG symbols so <use> works locally -->
  <svg  style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="btn-start" viewBox="0 0 195.83154 45.981833">
      <g transform="translate(-184.87527,-0.433794)">
        <path fill="#1a1a1a" d="m 214.36793,41.837793 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-28.970979 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.2002 l 0.0238,4.14 h 4.07204 l 0.0238,4.1439 h 4.144 l -0.0238,28.972159 h -4.144 l 0.0238,4.1439 h -4.14358 l 0.024,4.144 h -32.9612 z"/>
        <path fill="#000055" d="m 214.34407,37.693753 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-24.831019 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.1999 l 0.0238,4.14 h 4.1442 l 0.0238,4.1439 h 4.096 l -0.0238,24.832199 h -4.096 l 0.0238,4.1439 h -4.1919 l 0.024,4.144 h -32.98474 z"/>
        <path fill="#0000aa" d="m 214.32037,33.553753 h -4.12016 l -0.1438,-24.839999 h 4.12016 l -0.0238,-4.14 h 33.2002 l 0.0238,4.14 h 4.12014 l -0.0954,24.839999 h -4.12014 l 0.0238,4.14 h -32.9612 z"/>
        <path fill="#0000ff" d="m 214.32037,33.553753 -0.1438,-24.839999 h 33.2002 l -0.0954,24.839999 z"/>
        <path fill="#00ccff" d="m 218.32104,25.269853 h -4.09615 l -0.0483,-16.556099 4.12007,-2e-5 v -4.13998 h 24.91201 v 4.13998 l 4.16774,-3.4e-4 v 16.560359 h -4.17964 l 0.0238,4.14 -24.87589,-0.004 z"/>
        <path fill="#000" d="m 226.51306,14.933357 h 12.384 v 4.144397 h -4.12016 l 0.012,2.072 h -4.12016 l -0.0358,2.072 h -4.12016 z"/>
        <path fill="#0000ff" d="m 226.51267,8.717754 h 4.13231 l -0.012,2.072 h 4.12016 l 0.0119,2.072 h 4.13202 v 4.144 h -4.10811 l 0.012,2.072 h -4.12016 l -0.0358,2.072 h -4.13231 z"/>
      </g>
    </symbol>
    <symbol id="btn-stop" viewBox="0 0 195.83154 45.981833">
      <g transform="translate(-286.97479,90.724357)">
        <path fill="#1a1a1a" d="m 417.06275,-49.320358 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-28.970979 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.20052 l 0.0238,4.14 h 4.09623 l 0.0238,4.1439 h 4.144 l -0.0238,28.972159 h -4.144 l 0.0238,4.1439 h -4.16777 l 0.024,4.144 h -32.96152 z"/>
        <path fill="#550000" d="m 417.03889,-53.464398 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-24.831019 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.2002 l 0.0238,4.14 h 4.12041 l 0.0238,4.1439 h 4.144 l -0.0238,24.832199 h -4.144 l 0.0238,4.1439 h -4.19195 l 0.024,4.144 h -32.9612 z"/>
        <path fill="#aa0000" d="m 417.01519,-57.604398 h -4.12016 l -0.1438,-24.839999 h 4.12016 l -0.0238,-4.14 h 33.2002 l 0.0238,4.14 h 4.15611 l -0.0954,24.839999 h -4.15611 l 0.0238,4.14 h -32.9612 z"/>
        <path fill="#d40000" d="m 417.01519,-57.604398 -0.1438,-24.839999 h 33.2002 l -0.0954,24.839999 z"/>
        <path fill="#ff8080" d="m 421.03987,-65.888298 h -4.12016 l -0.0483,-16.556099 4.1678,-2e-5 -0.0238,-4.13998 h 24.8646 l 0.0238,4.13998 4.16742,-3.4e-4 v 16.560359 h -4.31042 l 0.0238,4.14 -24.7211,-0.004 z"/>
        <path fill="#000" d="m 312.75358,22.78496 v -2.072 h 12.36215 l -3e-4,2.072 z" transform="translate(114.60833,-90.724357)"/>
        <path fill="#aa0000" d="m 312.75354,20.71296 -0.071,-12.433 h 12.36124 l 0.0718,12.433 z" transform="translate(114.60833,-90.724357)"/>
      </g>
    </symbol>
  </svg>

  <div class="wrap">
    <h1></h1>
    <div class="controls">
      <div class="segments">
        <input id="modeE" type="radio" name="mode" value="E" checked>
        <label for="modeE">Erlkönig</label>
        <input id="modeD" type="radio" name="mode" value="D">
        <label for="modeD">Diavolo</label>
      </div>
      <div class="btnRow">
        <button id="btnStart" class="svgBtn" aria-label="Start">
          <svg class="icon" viewBox="0 0 195.83154 45.981833"><use href="#btn-start"></use></svg>
        </button>
        <button id="btnStop" class="svgBtn" aria-label="Stop" disabled>
          <svg class="icon" viewBox="0 0 195.83154 45.981833"><use href="#btn-stop"></use></svg>
        </button>
      </div>
    </div>

    <div class="card">
      <div>TIME LEFT (s)</div>
      <div class="big" id="timeLeft">10.00</div>
    </div>

    <div id="pianoArea">
      <!-- === Light, precise SVG (IDs preserved; positions unchanged) === -->
      <svg id="piano" viewBox="0 0 73.131003 76.755435" version="1.1" shape-rendering="crispEdges" xmlns="http://www.w3.org/2000/svg">
        <!-- Background frame -->
        <g id="bg" aria-hidden="true" pointer-events="none" transform="matrix(1.5,0,0,1.5,-115,-6)">
          <path fill="#000" d="M76.744203,4.2646566 125.498,4.263v51.168104l-24.37084,.00095-24.38316,.00095z"/>
          <path fill="#1a1a1a" d="m80.398296,51.774947 41.453594,-.0019v2.436l-41.453594,.0019zM124.28,5.4807167 124.288,55.428899h-1.21811l-.00049,-48.7310989-43.889197,.003 .000093,48.7303039-1.218093,-.000265V5.4826551ZM121.85187,49.338767l-4.87301,.000265 .0002,-32.894964-31.707562,.0026-.00053,32.894422h-4.8726l-.00013,-41.422162 41.453392,-.00186z"/>
          <path fill="#4d4d4d" d="m80.402919,40.812065 3.65473,-.000665v2.43645l-3.65473,.000665z m37.786051,-.0017 3.65473,-.000651v2.43645l-3.65473,.000651z"/>
          <path fill="#666" d="m80.402919,38.37393h3.65473v2.43747l-3.65473,.000665z m37.786051,-.000015 3.65473,.000015v2.435784l-3.65473,.000651z"/>
          <path fill="#e6e6e6" d="m107.20368,43.24785 9.76318,.0013v2.43645l-9.76318,-.0013z"/>
          <path fill="#f4eed7" d="m107.20368,45.6864 9.76318,-.000828v4.869921l-9.76318,.000828z"/>
          <path fill="#fff" d="m107.2038,18.883275 10.98553,-.0014 .00007,24.365167-10.98509,.0019z"/>
          <path fill="#333" d="m125.498,4.2627166h-2.436v1.2180001h1.218v1.218h1.218z m-48.754,.00194h2.436203V5.482652h-1.218v1.218h-1.218z m3.658895,6.0909014 41.439125,-.001v2.43645l-41.439125,.001z m.000024,32.892957 3.65473,-.000658v2.43645l-3.65473,.000658z m37.786051,-.0017 3.65473,-.000658v2.43645l-3.65473,.000658z m-37.786051,-7.307699 3.65473,-.000658v2.435472h-3.65473z m37.786051,-.0017 3.65473,-.000658v2.437172l-3.65473,-.000064z"/>
          <path fill="#800000" d="m85.275395,17.664276 31.691145,-.000602-.00029,1.218223-31.690855,.000602z"/>
          <path fill="#000" d="M79.198598,15.227826H123.0694v2.43645H79.198598Z m37.767442,2.435853h1.223l.00036,32.891814h-1.22254z m-32.908755,.000597h1.21811l.000364,9.545464v23.346351h-1.21811z"/>
        </g>

        <!-- Keys (C & D) -->
        <g id="keys" transform="matrix(1.5,0,0,1.5,-115,-6)">
          <g id="C1up" style="display:inline" transform="matrix(0.64971999,0,0,0.42231802,0.81216,-8.3245269)">
            <path fill="#ffffff" d="m 130,64.423065 h 14.99723 V 122.12035 H 130 Z"/>
            <path fill="#e6e6e6" d="m 130,122.12035 h 14.99723 v 5.76923 H 130 Z"/>
            <path fill="#f4eed7" d="m 130,127.88958 14.99723,0.001 V 139.423 H 130 Z"/>
            <path fill="#000000" d="m 139.37327,101.92456 5.72151,-3e-4 v 2.88408 l -5.72151,-0.001 z"/>
          </g>
          <g id="C1down" style="display:none" transform="matrix(0.64972001,0,0,0.42231802,0.8130748,-8.2494803)">
            <path fill="#ffffff" d="m 129.99728,64.243863 14.99854,0.0015 3.7e-4,66.346607 h -14.99723 z"/>
            <path fill="#e6e6e6" d="m 129.99863,130.59197 h 14.99756 l 3.2e-4,5.76922 -14.99722,-0.002 z"/>
            <path fill="#e9ddaf" d="m 129.99959,136.36119 14.99626,0.002 3.4e-4,2.88253 h -14.9966 z"/>
            <path fill="#000000" d="m 139.37517,101.74556 h 5.62445 v 5.76816 h -5.62445 z"/>
            <path fill="#333333" d="m 141.25033,101.74475 3.74929,0.001 v 2.88308 l -3.74929,-10e-4 z"/>
          </g>

          <g id="D1up" style="display:inline" transform="matrix(0.64972004,0,0,0.42231802,11.77619,-8.5681719)">
            <path fill="#ffffff" d="m 130,65 h 15 v 57.69834 h -15 z"/>
            <path fill="#e6e6e6" d="m 130,122.69834 h 15 v 5.76923 h -15 z"/>
            <path fill="#f4eed7" d="m 130,128.46757 h 15 v 11.53242 h -15 z"/>
            <path fill="#000000" d="m 130,102.50136 1.87086,-0.001 v 2.88408 L 130,105.38544 Z"/>
            <path fill="#000000" d="m 143.1018,102.49457 h 3.77348 v 2.88975 l -3.77348,-0.005 z"/>
          </g>
          <g id="D1down" style="display:none" transform="matrix(-0.65075372,0,0,0.42231802,190.5952,-8.3229698)">
            <path fill="#ffffff" d="M 130.02398,64.425958 145,64.423065 v 66.348105 h -14.97602 z"/>
            <path fill="#e6e6e6" d="M 130.02398,130.77117 145,130.76923 v 5.76922 l -14.97602,0.002 z"/>
            <path fill="#e9ddaf" d="M 130.02398,136.54045 145,136.53845 v 2.88462 l -14.97602,0.002 z"/>
            <path fill="#000000" d="m 143.12614,101.91957 1.86475,-0.003 -2.5e-4,5.77574 -1.8645,-0.001 z"/>
            <path fill="#000000" d="m 130.01724,101.92552 1.87167,0.002 v 5.76416 l -1.87167,-0.002 z"/>
            <path fill="#333333" d="m 128.14556,101.92707 h 1.87168 v 2.87264 l -1.87168,0.004 z"/>
            <path fill="#333333" d="m 144.99089,101.91657 1.87795,-0.006 v 2.87891 l -1.87795,0.006 z"/>
          </g>
        </g>

        <!-- Black keys (visual only) -->
        <g id="bk-top" aria-hidden="true" pointer-events="none" transform="matrix(1.5,0,0,1.5,-115,-6)">
          <g transform="matrix(0.60911264,0,0,0.37263356,15.261809,-5.3386809)">
            <path fill="#000" d="m124.94233,64.999983 9.99745,.000023V107.5002h-9.99805z"/>
            <path fill="#333" d="m126.94529,65.001332 5.9989,.000017v42.500191h-5.9989z"/>
            <path fill="#4d4d4d" d="m126.94531,65.000637h1.9998l.00001,32.692319 3.98921,.000215v3.269009l-5.98904,-.00021z"/>
          </g>
          <g transform="matrix(0.60911264,0,0,0.37263356,28.662105,-5.3375688)">
            <path fill="#000" d="M124.94552 64.99998 H134.94358 V110.76591 H128.94478 V107.50623 H124.94552 Z"/>
            <path fill="#333" d="m126.94529,64.99998 5.9989,.000017v42.500863l-5.99904,-.00088z"/>
            <path fill="#4d4d4d" d="m126.94506,65.000646h1.9998l.00001,32.692319 3.98921,.000215v3.26901l-5.98904,-.00021z"/>
          </g>
        </g>

        <!-- Fingers (hidden) -->
        <g id="finger1" style="display:none" pointer-events="none"><path fill="#1a1a1a" d="M 107.20383,10.964024 H 105.9856 V 9.7457963 h -3.65468 v 1.2182277 h -2.43645 v 1.218225 H 95.021572 V 10.964024 H 93.803344 V 9.7457963 H 92.585122 V 8.5275712 H 91.366899 V 7.309346 l -1.241508,-0.00482 0.02339,-1.2133961 1.218237,2.4e-6 V 2.4364527 h -1.218225 l -2.2e-5,-1.2182251 H 87.712204 V 2.4364503e-6 H 80.402851 V 1.2182276 H 77.9664 v 1.2182227 l -2.436435,2.4e-6 -2e-5,4.8729006 H 74.31174 l -2e-5,1.2182252 h -1.218225 l -0.0049,2.4510005 -1.213377,-0.01455 v 2.43645 H 70.65702 v 9.745799 h 1.218221 l 4e-6,1.218225 h 1.218226 v 1.218225 h 1.218225 v 1.218225 h 1.218215 l 1e-5,1.218225 3.654709,-2e-6 v -1.218225 h 1.218226 v 1.218225 l 1.218196,2e-6 v 1.218225 h 3.654702 v -1.218225 l 1.218169,-9e-6 5.6e-5,9.745811 h 1.218225 v 1.218225 h 1.218225 l -2.7e-5,1.218225 h 2.436451 v -1.21822 h 1.218225 v -1.218225 h 1.218225 l -3.2e-5,-7.309351 h -1.218222 v -6.091126 h -1.218223 l 2.7e-5,-4.872901 h 1.218225 v -1.218225 h 3.654675 v 1.218225 h 6.091097 v -1.218225 h 2.43645 v -1.218223 h 1.21822 l 3e-5,-1.218227 1.2182,2e-6 z"/></g>
        <g id="finger2" style="display:none" pointer-events="none"><path fill="#1a1a1a" d="m 84.057509,10.964021 h 1.21823 V 9.7457939 h 3.654676 v 1.2182271 h 2.43645 v 1.218226 h 4.872898 v -1.218226 h 1.218228 V 9.7457939 h 1.218222 V 8.5275687 h 1.218223 V 7.3093436 l 1.241504,-0.00482 -0.0234,-1.2133961 -1.218233,2.5e-6 V 2.4364503 h 1.218223 l 2e-5,-1.2182252 h 2.43657 V 0 h 7.30935 v 1.2182251 h 2.43645 v 1.2182228 l 2.43644,2.4e-6 2e-5,4.8729006 h 1.21821 l 1e-5,1.2182252 h 1.21823 l 0.005,2.4510009 1.21338,-0.01455 v 2.436451h 1.21822 v 9.745798 h -1.21822 v 1.218225 h -1.21823 v 1.218226 h -1.21822 v 1.218225 h -1.21822 l -10e-6,1.218225 -3.65471,-3e-6 v -1.218225 h -1.21822 v 1.218225 l -1.21825,3e-6 v 1.218225 h -3.6547 v -1.218225 l -1.21817,-10e-6 -5e-5,9.745811 h -1.21823 v 1.218225 h -1.21822 l 2e-5,1.218225 h -2.436446 v -1.218225 h -1.218226 v -1.218225 h -1.218225 l 3.2e-5,-7.309351 h 1.218223 v -6.091126 h 1.218222 l -2.6e-5,-4.8729 H 98.676208 V 18.27338 h -3.654675 v 1.218225 H 88.930439 V 18.27338 h -2.436453 v -1.218223 h -1.218222 l -3.2e-5,-1.218228 -1.218196,3e-6 z"/></g>
      </svg>
    </div>

    <div class="grid">
      <div class="card"><div>HITS</div><div id="hits" class="big">0</div></div>
      <div class="card"><div>STABILITY</div><div id="stability" class="big">0.000</div></div>
      <div class="card"><div>SCORE</div><div id="score" class="big">0</div></div>
    </div>
  </div>
  <div id="overlay"></div>

  <script>
  // ===== Tap-only minimal engine (no modules; browser-safe) =====
  const btnStart=document.getElementById('btnStart');
  const btnStop=document.getElementById('btnStop');
  const body=document.body;
  const elHits=document.getElementById('hits');
  const elStab=document.getElementById('stability');
  const elScore=document.getElementById('score');
  const elTime=document.getElementById('timeLeft');
  const area=document.getElementById('pianoArea');

  function swapSvgVisibility(upId, downId, isDown){
    const up = document.getElementById(upId);
    const dn = document.getElementById(downId);
    if(!up && !dn) return;
    if(up)  up.style.display = isDown ? 'none'  : 'inline';
    if(dn)  dn.style.display = isDown ? 'inline': 'none';
  }
  function setKeyVisual(note, isDown){
    if(note===60){
      swapSvgVisibility('C1up','C1down',!!isDown);
      const p = document.querySelector('#C1down path[d^="m 129.99728,64.243863"]');
      if(p) p.classList.toggle('glow-black', !!isDown);
    }
    if(note===62){
      swapSvgVisibility('D1up','D1down',!!isDown);
      const p = document.querySelector('#D1down path[d^="M 130.02398,64.425958"]');
      if(p) p.classList.toggle('glow-black', !!isDown);
    }
  }
  function resetKeyVisuals(){
    swapSvgVisibility('C1up','C1down',false);
    swapSvgVisibility('D1up','D1down',false);
    const pC=document.querySelector('#C1down path[d^="m 129.99728,64.243863"]'); if(pC) pC.classList.remove('glow-black');
    const pD=document.querySelector('#D1down path[d^="M 130.02398,64.425958"]'); if(pD) pD.classList.remove('glow-black');
  }

  let running=false,counting=false,ts=[]; // timestamps (ms)
  let mode='E';
  let lastAccepted=null;
  Array.from(document.querySelectorAll('input[name="mode"]')).forEach(r=>{
    r.onchange = async (e)=>{
      mode=r.value; lastAccepted=null; resetKeyVisuals();
      if (e && e.isTrusted) { try{ await ensureAudio(); }catch(_){ }
        const noteMap = { E:60, D:62 };
        const midi = noteMap[r.value] || 60; beep(midi, 110);
      }
    };
  });

  function flash(btn){ btn.classList.add('pressed'); setTimeout(()=>btn.classList.remove('pressed'),120); }
  btnStart.addEventListener('pointerdown', ()=> flash(btnStart));
  btnStop .addEventListener('pointerdown', ()=> flash(btnStop));

  function resetStats(){
    ts.length=0;
    elHits.textContent='0'; elStab.textContent='0.000'; elScore.textContent='0'; elTime.textContent='10.00';
  }

  // ===== Audio =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let audio = null;
  let audioUnlocked = false;

  async function ensureAudio(){
    if (!AC) return null;
    if (!audio || audio.state === 'closed'){
      audio = new AC({ latencyHint: 'interactive' });
      try{
        const g = audio.createGain(); g.gain.value = 1; g.connect(audio.destination);
        const buf = audio.createBuffer(1, 32, audio.sampleRate);
        const src = audio.createBufferSource(); src.buffer = buf; src.connect(g);
        src.start(audio.currentTime + 0.002);
      }catch(e){}
    }
    if (audio.state === 'suspended'){
      try{ await audio.resume(); }catch(e){ console.warn('resume failed', e); }
    }
    audioUnlocked = !!(audio && audio.state === 'running');
    return audio;
  }

  window.addEventListener('click', async () => {
    await ensureAudio();
    audioUnlocked = true;
  }, { once: true });

  window.addEventListener('keydown', async () => {
    if (!audioUnlocked) { await ensureAudio(); audioUnlocked = true; }
  }, { once:true });

  let muted = false;  // テスト用ミュート
  function setMuted(on){
    muted = !!on; document.body.classList.toggle('muted', muted);
  }
  function toggleMuted(){ setMuted(!muted); }
  if (location.search.includes('mute=1')) setMuted(true);

  function beep(midi, vel = 100){
    if (!audioUnlocked || !audio || muted) return;
    const t0 = audio.currentTime, len = 0.08;
    const osc = audio.createOscillator();
    const g = audio.createGain();
    osc.type = 'square';
    osc.frequency.value = 440 * Math.pow(2,(midi-69)/12);
    const v = Math.max(0.08, Math.min(1, vel/127));
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.linearRampToValueAtTime(0.25*v, t0+0.003);
    g.gain.linearRampToValueAtTime(0.0001, t0+len);
    osc.connect(g).connect(audio.destination);
    osc.start(t0);
    osc.stop(t0+len);
  }

  // ========= Speech (female voice + Excellent >= 7000) =========
  async function getVoicesAsync(){
    if (!('speechSynthesis' in window)) return [];
    const have = speechSynthesis.getVoices();
    if (have && have.length) return have;
    return new Promise(res=>{
      const onv = ()=>{ speechSynthesis.removeEventListener('voiceschanged', onv); res(speechSynthesis.getVoices()||[]); };
      speechSynthesis.addEventListener('voiceschanged', onv);
      setTimeout(()=>res(speechSynthesis.getVoices()||[]), 500);
    });
  }
  function pickPreferredEnFemale(voices){
    if (!voices || !voices.length) return null;
    const femaleHints = /(samantha|victoria|karen|zira|aria|ana|female|google.*english.*female)/i;
    const enUS = voices.filter(v => /en[-_]US/i.test(v.lang||''));
    const hit = enUS.find(v => femaleHints.test(`${v.name} ${v.voiceURI}`));
    if (hit) return hit;
    if (enUS[0]) return enUS[0];
    const enAny = voices.find(v => /^en[-_]/i.test(v.lang||''));
    return enAny || voices[0] || null;
  }
  let speechReady = false;
  let lastUtter = null;
  async function unlockSpeech(){
    if (!('speechSynthesis' in window) || speechReady) return;
    await getVoicesAsync();
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('');
      u.lang = 'en-US';
      u.volume = 0; // 無音
      u.onend = ()=>{ speechReady = true; };
      speechSynthesis.speak(u);
    }catch(e){}
  }
  window.addEventListener('pointerdown', unlockSpeech, { once:true });
  window.addEventListener('keydown',     unlockSpeech, { once:true });
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'visible' && 'speechSynthesis' in window){
      try{ speechSynthesis.resume(); }catch(e){}
    }
  });

  function formatScoreTwoDigits(score){
    const n = Math.max(0, Number(score)|0);
    const W2 = {
      '00':'zero','01':'one','02':'two','03':'three','04':'four','05':'five','06':'six','07':'seven','08':'eight','09':'nine',
      '10':'ten','11':'eleven','12':'twelve','13':'thirteen','14':'fourteen','15':'fifteen','16':'sixteen','17':'seventeen','18':'eighteen','19':'nineteen',
      '20':'twenty','21':'twenty-one','22':'twenty-two','23':'twenty-three','24':'twenty-four','25':'twenty-five','26':'twenty-six','27':'twenty-seven','28':'twenty-eight','29':'twenty-nine',
      '30':'thirty','31':'thirty-one','32':'thirty-two','33':'thirty-three','34':'thirty-four','35':'thirty-five','36':'thirty-six','37':'thirty-seven','38':'thirty-eight','39':'thirty-nine',
      '40':'forty','41':'forty-one','42':'forty-two','43':'forty-three','44':'forty-four','45':'forty-five','46':'forty-six','47':'forty-seven','48':'forty-eight','49':'forty-nine',
      '50':'fifty','51':'fifty-one','52':'fifty-two','53':'fifty-three','54':'fifty-four','55':'fifty-five','56':'fifty-six','57':'fifty-seven','58':'fifty-eight','59':'fifty-nine',
      '60':'sixty','61':'sixty-one','62':'sixty-two','63':'sixty-three','64':'sixty-four','65':'sixty-five','66':'sixty-six','67':'sixty-seven','68':'sixty-eight','69':'sixty-nine',
      '70':'seventy','71':'seventy-one','72':'seventy-two','73':'seventy-three','74':'seventy-four','75':'seventy-five','76':'seventy-six','77':'seventy-seven','78':'seventy-eight','79':'seventy-nine',
      '80':'eighty','81':'eighty-one','82':'eighty-two','83':'eighty-three','84':'eighty-four','85':'eighty-five','86':'eighty-six','87':'eighty-seven','88':'eighty-eight','89':'eighty-nine',
      '90':'ninety','91':'ninety-one','92':'ninety-two','93':'ninety-three','94':'ninety-four','95':'ninety-five','96':'ninety-six','97':'ninety-seven','98':'ninety-eight','99':'ninety-nine'
    };
    const W1 = ['zero','one','two','three','four','five','six','seven','eight','nine'];
    if (n < 10) return `${W1[n]} points.`;
    if (n < 100) return `${W2[String(n).padStart(2,'0')]} points.`;
    const s4 = String(n).padStart(4,'0');
    const a = s4.slice(0,2);
    const b = s4.slice(2);
    const partA = (a === '00') ? '' : W2[a];
    const partB = (b === '00') ? '' : W2[b];
    const phrase = [partA, partB].filter(Boolean).join(' ');
    return `${phrase || 'zero'} points.`;
  }
  async function speakResult(score, {lang='en-US'}={}){
    if (!('speechSynthesis' in window)) return;
    if (!speechReady) {
      await unlockSpeech();
      if (!speechReady) { setTimeout(()=>{ if (speechReady) speakResult(score,{lang}); }, 80); return; }
    }
    const voices = await getVoicesAsync();
    const v = pickPreferredEnFemale(voices);
    const isExcellent = Number(score) >= 7000;
    const formatted = formatScoreTwoDigits(Number(score));
    const text = isExcellent ? `Excellent! ${formatted}` : formatted;
    try{
      if (lastUtter) { try{ speechSynthesis.cancel(); }catch(e){} }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang   = 'en-US';
      utter.rate   = 1.0;
      utter.pitch  = 2;
      utter.volume = 1.0;
      if (v) utter.voice = v;
      lastUtter = utter;
      speechSynthesis.speak(utter);
    }catch(e){ console.warn('TTS failed:', e); }
  }

  // === Voice (or beep) countdown ===
  const USE_VOICE_COUNTDOWN = true; // ビープに戻す場合は false
  const FAST_DIGITS = false; // digits not used now         // 3/2/1 を早口＆短尺に

// BURST の喋る速さ（1.0=標準。早くしたいなら 1.15〜1.35 あたり）
const BURST_RATE = 1.15;


// 音声で言えたら true、ダメならビープにフォールバックして false を返す
function speakCountdown(label){
  return new Promise(async (resolve)=>{
    const fallback = ()=>{
      // フォールバックは短いビープ
      const tone = (label==='BURST!') ? 72 : 60;
      ensureAudio().then(()=>{ try{ beep(tone, label==='BURST!'?127:110); }catch(_){} });
      resolve(false);
    };

    if (!USE_VOICE_COUNTDOWN || !('speechSynthesis' in window)) { fallback(); return; }

    try{
      await unlockSpeech(); // iOS 対策：ユーザー操作後にアンロック
      const voices = await getVoicesAsync();
      const v = pickPreferredEnFemale(voices);

      const u = new SpeechSynthesisUtterance(String(label).replace('BURST!','Burst'));
      u.lang   = 'en-US';
      u.rate   = (label==='BURST!') ? BURST_RATE : 1.0;  // ← ここで速さ
      u.pitch  = 2;
      u.volume = 1.0;
      if (v) u.voice = v;

      let started = false;
      u.onstart = ()=>{ started = true; };
      u.onerror = ()=>{ fallback(); };
      u.onend   = ()=>{ resolve(true); };

      // 直前に話していたらだけ cancel（無闇に cancel すると失敗する端末がある）
      try{ if (speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){}
      speechSynthesis.speak(u);

      // iOS/Safari で start が来なかったときの保険（声が出なければビープへ）
      setTimeout(()=>{ if (!started) fallback(); }, 450);
    }catch(e){
      fallback();
    }
  });
}

// READY→BURST! だけ。BURST 言い終わり（onend）で startRun()
function startCountdown(){
  if (running || counting) return;
  counting = true;
  resetStats();
  document.body.classList.add('playing');

  const overlay = document.getElementById('overlay');
  overlay.classList.add('show');

  (async ()=>{
    overlay.textContent = 'READY';
    await speakCountdown('READY');     // READY は onend 待ち

    overlay.textContent = 'BURST!';
    await speakCountdown('BURST!');    // BURST 言い終わりで開始
    if (!counting) return;

    overlay.classList.remove('show');
    overlay.textContent = '';
    counting = false;
    startRun();
  })();
}


  // ===== Game loop =====
  let timerId=null, endAt=0;
  function startRun(){
    running=true; btnStop.disabled=false; btnStart.disabled=true; ts.length=0; lastAccepted=null; ensureAudio();
    const DURATION=10000; // 10s
    const t0=performance.now(); endAt=t0+DURATION;
    const tick=()=>{
      const now=performance.now();
      const left=Math.max(0, endAt-now);
      elTime.textContent=(left/1000).toFixed(2);
      if (left<=0){ finish(); return; }
      timerId=requestAnimationFrame(tick);
    };
    timerId=requestAnimationFrame(tick);
  }
  function finish(){
    if(timerId){ cancelAnimationFrame(timerId); timerId=null; }
    running=false; counting=false; btnStop.disabled=true; btnStart.disabled=false; body.classList.remove('playing');
    // 簡易スコア読み上げ
    speakResult(Number(elScore.textContent)||0);
    resetKeyVisuals();
  }

  // ===== Tap logic =====
  function noteFromPos(evt){
    const r = area.getBoundingClientRect();
    const x = (evt.clientX ?? (evt.touches && evt.touches[0] && evt.touches[0].clientX) ?? r.left);
    const ratio = (x - r.left) / Math.max(1, r.width);
    return (ratio < 0.5) ? 60 : 62; // left:C(60), right:D(62)
  }
  function tapToNote(evt){
    const n = noteFromPos(evt);
    if (mode==='E'){
      if (n!==60) return null; // C のみ
    } else if (mode==='D'){
      if (lastAccepted===n) return null; // トリル（交互）
    }
    return { note:n };
  }

  function onDown(evt){
    if(!running) return;
    const res = tapToNote(evt);
    if(!res) return;
    lastAccepted = res.note;
    ts.push(performance.now());
    // HITS & SCORE（簡易）
    elHits.textContent = String(Number(elHits.textContent)+1);
    elScore.textContent = String(Number(elScore.textContent)+ (mode==='E'?1:2));
    // ビジュアル & ビープ
    setKeyVisual(res.note, true);
    ensureAudio().then(()=>beep(res.note, 115));
  }
  function onUp(evt){
    if(!running) return;
    // どちらのキーか再判定して戻す（左右どちらでもOK）
    const n = noteFromPos(evt);
    setKeyVisual(n, false);
  }
  area.addEventListener('pointerdown', onDown);
  window.addEventListener('pointerup', onUp);

  // Buttons
  btnStart.addEventListener('click', ()=> startCountdown());
  btnStop .addEventListener('click', ()=> finish());

  // ===== Developer tests =====
  (function runDevTests(){
    if(!/[?&]test=1\b/.test(location.search)) return;
    console.log('[tests] start');
    const r = area.getBoundingClientRect ? area.getBoundingClientRect() : {left:0,width:100};
    // E mode: only C accepted
    mode='E'; lastAccepted=null;
    console.assert((tapToNote({clientX:r.left+0.1*r.width, pressure:1})||{}).note===60, 'E:C left ok');
    console.assert(tapToNote({clientX:r.left+0.9*r.width, pressure:1})===null, 'E:D right ignored');
    // D mode: alternate required
    mode='D'; lastAccepted=60;
    console.assert(tapToNote({clientX:r.left+0.1*r.width, pressure:1})===null, 'D:C repeat ignored');
    lastAccepted=60; console.assert((tapToNote({clientX:r.left+0.9*r.width, pressure:1})||{}).note===62, 'D:D accepted after C');
    // noteFromPos helper
    const nn = noteFromPos({clientX:r.left+0.75*r.width});
    console.assert(nn===62, 'noteFromPos right→D');
    console.log('[tests] ok');
  })();
  </script>
</body>
</html>
