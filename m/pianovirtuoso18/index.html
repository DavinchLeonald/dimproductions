<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="preload" href="https://dim.productions/assets/fonts/PressStart2P.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="canonical" href="https://dim.productions/pianovirtuoso18">
  <title>Piano Virtuoso 18</title>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%; overscroll-behavior: none; touch-action: manipulation; -webkit-text-size-adjust: 100%; overflow-x:hidden;}
    body{-webkit-touch-callout:none;-webkit-user-select:none}
    @font-face{
      font-family:'Press Start 2P';
      src:url('https://dim.productions/assets/fonts/PressStart2P.woff2') format('woff2'),
          url('/assets/fonts/PressStart2P.woff2') format('woff2');
      font-style:normal;font-weight:400;font-display:swap;
    }
    body{margin:0;background:#000;color:#fff;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;text-align:center;font-synthesis:none}
.wrap{
  max-width: 800px;
  margin: 0 auto;
  padding: 16px var(--safe-pad,16px);
  min-height: 100vh;
  display: grid;
  grid-template-rows: auto auto 1fr auto;
  justify-items: center;             /* ← 中央寄せの主役 */
}
/* ステージ幅：ピアノに合わせて中央に */
.controls,
#pianoArea{
  width: min(100%, 480px);           /* 420/480などSVG側に合わせる */
}
    h1{font:700 18px/1.2 'Press Start 2P',monospace;margin:6px 0 12px;letter-spacing:.5px}
    #overlay,.big,.segments label{font-family:'Press Start 2P',monospace}
    .card>div:first-child{font-family:'Press Start 2P',monospace;font-weight:700;letter-spacing:.3px}

    .controls{display:flex;flex-direction:column;gap:12px;align-items:center}
    .segments{display:flex;gap:10px}
    .segments label{ padding:8px 12px; cursor:pointer; background:transparent; font-size:16px; line-height:1.2; }
    .segments input{display:none}
    .segments input:checked+label{background:#b5001e;color:#000}

    .btnRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:var(--btn-gap);
  flex-wrap:nowrap;            /* ← できるだけ改行しない */
  padding:2px var(--safe-pad); /* ← 端に寄りすぎ対策 */
  overflow:visible;
  min-width:0;
}
    @media (max-width:480px){
  .btnRow{ flex-wrap:nowrap; } /* 幅はアイコン側で自動縮小 */
}
@media (min-width:768px){
  .btnRow{ gap:max(var(--btn-gap), 14px); }
}
    button{ padding:0; border:none; background:transparent; cursor:pointer; margin:0; line-height:0; }
    .svgBtn{
  display:inline-grid;
  place-items:center;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
  -webkit-touch-callout:none;
  min-width:0;
  flex:0 1 auto;
}
    .svgBtn .icon{
  width: min(var(--btn-icon-max), var(--btn-icon-fit));
  height:auto;
  transition:filter .25s ease, transform .06s;
  overflow:visible;
}
    .svgBtn .icon use{transition:filter .25s ease}
    .svgBtn.pressed .icon{transform:translateY(3px) scale(.98)}

    /* 初期状態: start青く光る, stop消灯 */
    #btnStart .icon{filter:drop-shadow(0 0 10px rgba(0,180,255,.9)) drop-shadow(0 0 25px rgba(0,180,255,.6));}
    #btnStop .icon{filter:none;opacity:0.6}

    /* プレイ中（start押下→stop有効）: stop赤く光り、start消灯 */
    body.playing #btnStart .icon{filter:none;opacity:0.6}
    body.playing #btnStop .icon{filter:drop-shadow(0 0 10px rgba(255,60,60,.9)) drop-shadow(0 0 25px rgba(255,0,0,.6));opacity:1}

    .card{background:#111;padding:10px;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .big{font-weight:700;font-size:20px;line-height:1.1;font-family:'Press Start 2P',monospace}

    #pianoArea{display:flex;justify-content:center;align-items:stretch;margin-inline:auto;max-width:100%;user-select:none;-webkit-user-select:none;touch-action:none;overscroll-behavior:contain;overflow:hidden;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;flex:1}
    #pianoArea svg{display:block;width:min(420px,100%);height:auto;max-height:100%;margin:0 auto;}
    @media (min-width:768px){#pianoArea svg{width:clamp(360px,70vw,560px);}}
    .spacer-md{height:12px}

    /* Result modal */
    #resultModal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:none;align-items:center;justify-content:center;z-index:2147483646}
    #resultModal.show{display:flex}
    #resultModal .panel{background:#0b0b0b;border:1px solid #222;padding:18px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.6);width:min(520px,86vw)}
    #resultModal h2{margin:0 0 14px;font:700 16px/1.2 'Press Start 2P',monospace;letter-spacing:.4px}
    #resultModal .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    #resultModal .card{background:#111;padding:10px}
    #resultModal .big{font:700 20px/1.1 'Press Start 2P',monospace}
    #resultModal .actions{display:flex;justify-content:center;margin-top:14px}
    #resultModal .actions button{padding:10px 14px;background:#222;border:1px solid #444;border-radius:10px;color:#fff;cursor:pointer;font:700 12px 'Press Start 2P',monospace}
    body.playing #resultModal{display:none}
    /* Hide inline grid when using modal */
    .grid.inlineScore{display:none}
    .key{display:flex;align-items:center;justify-content:center;transition:transform .06s ease, filter .06s ease}
    .key.down{transform:translateY(2px) scaleY(.985); filter:brightness(1.15)}
    .glow-black{filter:drop-shadow(0 0 10px rgba(0,0,0,.95)) drop-shadow(0 0 26px rgba(0,0,0,.85)) brightness(.85) contrast(1.1);} 
    .key .label{opacity:.6; font-weight:700}
    .key:active{filter:brightness(1.2)}

/* Show Time Left only during actual gameplay (after BURST) */
#pianoArea{ position: relative; }  /* ← 追加（基準にする） */

#timeCard{
  display: none;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  /* 上の余白から少し下へ食い込ませる（調整用の変数） */
  top: calc(-1 * var(--time-overlap, 10px));
  pointer-events: none;  /* ← タップを貫通させる（鍵盤に干渉しない） */
  z-index: 2;
}
body.running #timeCard{ display: block; }
    body.running #timeCard[aria-hidden]{aria-hidden:false}

#timeCard{ background: rgba(17,17,17,.9); }

    #overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.5);color:#ff5050;font:700 clamp(40px,10vw,120px)/1 'Press Start 2P',monospace;opacity:0;pointer-events:none;transition:.15s;z-index:2147483647;will-change:opacity}
    #overlay.show{opacity:1}

:root{
  --btn-gap: 12px;
  /* 左右の安全余白（iPhone のノッチ/ホームバー + 16px 基本余白） */
  --safe-pad: max(16px, env(safe-area-inset-left), env(safe-area-inset-right));
  /* デスクトップ上限 */
  --btn-icon-max: 300px;
  /* 2ボタンが必ず横に収まるように画面幅から安全余白とギャップを引いて÷2 */
  --btn-icon-fit: calc((100vw - (var(--safe-pad) * 2) - var(--btn-gap)) / 2);
}
  </style>
</head>
<body>
  <!-- Inline SVG symbols so <use> works locally -->
  <svg  style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="btn-start" viewBox="0 0 195.83154 45.981833">
      <g transform="translate(-184.87527,-0.433794)">
        <path fill="#1a1a1a" d="m 214.36793,41.837793 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-28.970979 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.2002 l 0.0238,4.14 h 4.07204 l 0.0238,4.1439 h 4.144 l -0.0238,28.972159 h -4.144 l 0.0238,4.1439 h -4.14358 l 0.024,4.144 h -32.9612 z"/>
        <path fill="#000055" d="m 214.34407,37.693753 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-24.831019 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.1999 l 0.0238,4.14 h 4.1442 l 0.0238,4.1439 h 4.096 l -0.0238,24.832199 h -4.096 l 0.0238,4.1439 h -4.1919 l 0.024,4.144 h -32.98474 z"/>
        <path fill="#0000aa" d="m 214.32037,33.553753 h -4.12016 l -0.1438,-24.839999 h 4.12016 l -0.0238,-4.14 h 33.2002 l 0.0238,4.14 h 4.12014 l -0.0954,24.839999 h -4.12014 l 0.0238,4.14 h -32.9612 z"/>
        <path fill="#0000ff" d="m 214.32037,33.553753 -0.1438,-24.839999 h 33.2002 l -0.0954,24.839999 z"/>
        <path fill="#00ccff" d="m 218.32104,25.269853 h -4.09615 l -0.0483,-16.556099 4.12007,-2e-5 v -4.13998 h 24.91201 v 4.13998 l 4.16774,-3.4e-4 v 16.560359 h -4.17964 l 0.0238,4.14 -24.87589,-0.004 z"/>
        <path fill="#000" d="m 226.51306,14.933357 h 12.384 v 4.144397 h -4.12016 l 0.012,2.072 h -4.12016 l -0.0358,2.072 h -4.12016 z"/>
        <path fill="#0000ff" d="m 226.51267,8.717754 h 4.13231 l -0.012,2.072 h 4.12016 l 0.0119,2.072 h 4.13202 v 4.144 h -4.10811 l 0.012,2.072 h -4.12016 l -0.0358,2.072 h -4.13231 z"/>
      </g>
    </symbol>
    <symbol id="btn-stop" viewBox="0 0 195.83154 45.981833">
      <g transform="translate(-286.97479,90.724357)">
        <path fill="#1a1a1a" d="m 417.06275,-49.320358 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-28.970979 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.20052 l 0.0238,4.14 h 4.09623 l 0.0238,4.1439 h 4.144 l -0.0238,28.972159 h -4.144 l 0.0238,4.1439 h -4.16777 l 0.024,4.144 h -32.96152 z"/>
        <path fill="#550000" d="m 417.03889,-53.464398 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-24.831019 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.2002 l 0.0238,4.14 h 4.12041 l 0.0238,4.1439 h 4.144 l -0.0238,24.832199 h -4.144 l 0.0238,4.1439 h -4.19195 l 0.024,4.144 h -32.9612 z"/>
        <path fill="#aa0000" d="m 417.01519,-57.604398 h -4.12016 l -0.1438,-24.839999 h 4.12016 l -0.0238,-4.14 h 33.2002 l 0.0238,4.14 h 4.15611 l -0.0954,24.839999 h -4.15611 l 0.0238,4.14 h -32.9612 z"/>
        <path fill="#d40000" d="m 417.01519,-57.604398 -0.1438,-24.839999 h 33.2002 l -0.0954,24.839999 z"/>
        <path fill="#ff8080" d="m 421.03987,-65.888298 h -4.12016 l -0.0483,-16.556099 4.1678,-2e-5 -0.0238,-4.13998 h 24.8646 l 0.0238,4.13998 4.16742,-3.4e-4 v 16.560359 h -4.31042 l 0.0238,4.14 -24.7211,-0.004 z"/>
        <path fill="#000" d="m 312.75358,22.78496 v -2.072 h 12.36215 l -3e-4,2.072 z" transform="translate(114.60833,-90.724357)"/>
        <path fill="#aa0000" d="m 312.75354,20.71296 -0.071,-12.433 h 12.36124 l 0.0718,12.433 z" transform="translate(114.60833,-90.724357)"/>
      </g>
    </symbol>
  </svg>

  <div class="wrap">
    <h1></h1>
    <div class="controls">
      <div class="segments">
        <input id="modeE" type="radio" name="mode" value="E" checked>
        <label for="modeE">Erlkönig</label>
        <input id="modeD" type="radio" name="mode" value="D">
        <label for="modeD">Diavolo</label>
      </div>
      <div class="btnRow">
        <button id="btnStart" class="svgBtn" aria-label="Start">
          <svg class="icon" viewBox="0 0 195.83154 45.981833"><use href="#btn-start"></use></svg>
        </button>
        <button id="btnStop" class="svgBtn" aria-label="Stop" disabled>
          <svg class="icon" viewBox="0 0 195.83154 45.981833"><use href="#btn-stop"></use></svg>
        </button>
      </div>
    </div>

    <!-- PIANO AREA (was missing) -->
    <div id="pianoArea" aria-label="Piano Keys">
      <!-- You will paste the real SVG here. Placeholder below keeps layout & event targets alive. -->


    <div class="card" id="timeCard" aria-live="polite" aria-hidden="true">
      <div>TIME LEFT (s)</div>
      <div class="big" id="timeLeft">10.00</div>
    </div>

    </div><!-- end of pianoArea -->


    <div class="grid inlineScore">
      <div class="card"><div>HITS</div><div id="hits" class="big">0</div></div>
      <div class="card"><div>STABILITY</div><div id="stability" class="big">0.000</div></div>
      <div class="card"><div>SCORE</div><div id="score" class="big">0</div></div>
    </div>
  </div>
  <div id="overlay"></div>

  <!-- Result modal -->
  <div id="resultModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <h2>RESULT</h2>
      <div class="grid">
        <div class="card"><div>HITS</div><div id="rHits" class="big">0</div></div>
        <div class="card"><div>STABILITY</div><div id="rStab" class="big">0.000</div></div>
        <div class="card"><div>SCORE</div><div id="rScore" class="big">0000</div></div>
      </div>
      <div class="actions"><button id="closeResult">OK</button></div>
    </div>
  </div>

  <script>
  // ===== Tap-only minimal engine (no modules; browser-safe) =====
  const btnStart=document.getElementById('btnStart');
  const btnStop=document.getElementById('btnStop');
  const body=document.body;
  const elHits=document.getElementById('hits');
  const elStab=document.getElementById('stability');
  const elScore=document.getElementById('score');
  const resultModal=document.getElementById('resultModal');
  const rHits=document.getElementById('rHits');
  const rStab=document.getElementById('rStab');
  const rScore=document.getElementById('rScore');
  const btnCloseResult=document.getElementById('closeResult');
  const elTime=document.getElementById('timeLeft');
  const area=document.getElementById('pianoArea');

  // Guard: if area is missing for any reason, create one to avoid null errors
  if(!area){
    const fallback=document.createElement('div');
    fallback.id='pianoArea';
    fallback.style.minHeight='320px';
    document.querySelector('.wrap').insertBefore(fallback, document.querySelector('.wrap').children[2]);
  }

  function swapSvgVisibility(upId, downId, isDown){
    const up = document.getElementById(upId);
    const dn = document.getElementById(downId);
    if(!up && !dn) return;
    if(up)  up.style.display = isDown ? 'none'  : 'inline';
    if(dn)  dn.style.display = isDown ? 'inline': 'none';
  }
  function pressPath(note){
    return document.querySelector(note===60 ? '#C1down path' : '#D1down path');
  }
  function setKeyVisual(note, isDown){
    if(note===60){
      swapSvgVisibility('C1up','C1down',!!isDown);
      const p = pressPath(60);
      if(p) p.classList.toggle('glow-black', !!isDown);
    }
    if(note===62){
      swapSvgVisibility('D1up','D1down',!!isDown);
      const p = pressPath(62);
      if(p) p.classList.toggle('glow-black', !!isDown);
    }
  }
  function resetKeyVisuals(){
    swapSvgVisibility('C1up','C1down',false);
    swapSvgVisibility('D1up','D1down',false);
    const pC = pressPath(60); if(pC) pC.classList.remove('glow-black');
    const pD = pressPath(62); if(pD) pD.classList.remove('glow-black');
  }

  let running=false,counting=false,ts=[]; let scoreNum=0; // timestamps (ms)
  let mode='E';
  let lastAccepted=null;
  Array.from(document.querySelectorAll('input[name="mode"]')).forEach(r=>{
    r.onchange = async (e)=>{
      mode=r.value; lastAccepted=null; resetKeyVisuals();
      if (e && e.isTrusted) { try{ await ensureAudio(); }catch(_){ }
        const noteMap = { E:60, D:62 };
        const midi = noteMap[r.value] || 60; beep(midi, 110);
      }
    };
  });

  function flash(btn){ btn.classList.add('pressed'); setTimeout(()=>btn.classList.remove('pressed'),120); }
  btnStart.addEventListener('pointerdown', ()=> flash(btnStart));
  btnStop .addEventListener('pointerdown', ()=> flash(btnStop));

  function renderScore(){ elScore.textContent = String(scoreNum).padStart(4,'0'); }
  function calcIntervals(arr){
    if (!arr || arr.length < 2) return [];
    const out=[]; for(let i=1;i<arr.length;i++) out.push(arr[i]-arr[i-1]);
    return out;
  }
  function calcStability(){
    const iv = calcIntervals(ts);
    if (iv.length < 2) return 0;
    const mu = iv.reduce((a,b)=>a+b,0)/iv.length;
    const sd = Math.sqrt(iv.reduce((s,x)=>s+(x-mu)*(x-mu),0)/iv.length);
    const stab = Math.max(0, Math.min(1, 1 - (sd/(mu||1))));
    return stab; // 0..1 (higher is better)
  }
  function updateStability(){
    const stab = calcStability();
    elStab.textContent = stab.toFixed(3);
  }
  function resetStats(){
    ts.length=0; scoreNum=0;
    elHits.textContent='0';
    elStab.textContent='0.000';
    renderScore();
    elTime.textContent='10.00';
  }

  // ===== Audio =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let audio = null;
  let audioUnlocked = false;

  async function ensureAudio(){
    if (!AC) return null;
    if (!audio || audio.state === 'closed'){
      audio = new AC({ latencyHint: 'interactive' });
      try{
        const g = audio.createGain(); g.gain.value = 1; g.connect(audio.destination);
        const buf = audio.createBuffer(1, 32, audio.sampleRate);
        const src = audio.createBufferSource(); src.buffer = buf; src.connect(g);
        src.start(audio.currentTime + 0.002);
      }catch(e){}
    }
    if (audio.state === 'suspended'){
      try{ await audio.resume(); }catch(e){ console.warn('resume failed', e); }
    }
    audioUnlocked = !!(audio && audio.state === 'running');
    return audio;
  }

  window.addEventListener('pointerdown', async () => {
    await ensureAudio();
    audioUnlocked = true;
  }, { once: true });

  window.addEventListener('keydown', async () => {
    if (!audioUnlocked) { await ensureAudio(); audioUnlocked = true; }
  }, { once:true });

  let muted = false;  // テスト用ミュート
  function setMuted(on){
    muted = !!on; document.body.classList.toggle('muted', muted);
  }
  function toggleMuted(){ setMuted(!muted); }
  if (location.search.includes('mute=1')) setMuted(true);

  function beep(midi, vel = 100){
    if (!audio || muted) return;
    if (audio.state === 'suspended') { audio.resume().catch(()=>{}); }

    const now = audio.currentTime || 0;
    const startAt = now + 0.008; // iOS 初回落ち防止オフセット
    const len = 0.09;

    try{
      const osc = audio.createOscillator();
      const g = audio.createGain();
      osc.type = 'square';
      osc.frequency.value = 440 * Math.pow(2,(midi-69)/12);
      const v = Math.max(0.08, Math.min(1, vel/127));
      g.gain.setValueAtTime(0.0001, startAt);
      g.gain.linearRampToValueAtTime(0.25*v, startAt+0.006);
      g.gain.linearRampToValueAtTime(0.0001, startAt+len);
      osc.connect(g).connect(audio.destination);
      osc.start(startAt);
      osc.stop(startAt+len);
    }catch(e){ /* noop */ }
  }

  // ========= Speech (female voice + Excellent >= 7000) =========
  async function getVoicesAsync(){
    if (!('speechSynthesis' in window)) return [];
    const have = speechSynthesis.getVoices();
    if (have && have.length) return have;
    return new Promise(res=>{
      const onv = ()=>{ speechSynthesis.removeEventListener('voiceschanged', onv); res(speechSynthesis.getVoices()||[]); };
      speechSynthesis.addEventListener('voiceschanged', onv);
      setTimeout(()=>res(speechSynthesis.getVoices()||[]), 500);
    });
  }
  function pickPreferredEnFemale(voices){
    if (!voices || !voices.length) return null;
    const femaleHints = /(samantha|victoria|karen|zira|aria|ana|female|google.*english.*female)/i;
    const enUS = voices.filter(v => /en[-_]US/i.test(v.lang||''));
    const hit = enUS.find(v => femaleHints.test(`${v.name} ${v.voiceURI}`));
    if (hit) return hit;
    if (enUS[0]) return enUS[0];
    const enAny = voices.find(v => /^en[-_]/i.test(v.lang||''));
    return enAny || voices[0] || null;
  }
  let speechReady = false;
  let lastUtter = null;
  async function unlockSpeech(){
    if (!('speechSynthesis' in window) || speechReady) return;
    await getVoicesAsync();
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('');
      u.lang = 'en-US';
      u.volume = 0; // 無音
      u.onend = ()=>{ speechReady = true; };
      speechSynthesis.speak(u);
    }catch(e){}
  }
  window.addEventListener('pointerdown', unlockSpeech, { once:true });
  window.addEventListener('keydown',     unlockSpeech, { once:true });
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'visible' && 'speechSynthesis' in window){
      try{ speechSynthesis.resume(); }catch(e){}
    }
  });

  function formatScoreTwoDigits(score){
    const n = Math.max(0, Number(score)|0);
    const W2 = {
      '00':'zero','01':'one','02':'two','03':'three','04':'four','05':'five','06':'six','07':'seven','08':'eight','09':'nine',
      '10':'ten','11':'eleven','12':'twelve','13':'thirteen','14':'fourteen','15':'fifteen','16':'sixteen','17':'seventeen','18':'eighteen','19':'nineteen',
      '20':'twenty','21':'twenty-one','22':'twenty-two','23':'twenty-three','24':'twenty-four','25':'twenty-five','26':'twenty-six','27':'twenty-seven','28':'twenty-eight','29':'twenty-nine',
      '30':'thirty','31':'thirty-one','32':'thirty-two','33':'thirty-three','34':'thirty-four','35':'thirty-five','36':'thirty-six','37':'thirty-seven','38':'thirty-eight','39':'thirty-nine',
      '40':'forty','41':'forty-one','42':'forty-two','43':'forty-three','44':'forty-four','45':'forty-five','46':'forty-six','47':'forty-seven','48':'forty-eight','49':'forty-nine',
      '50':'fifty','51':'fifty-one','52':'fifty-two','53':'fifty-three','54':'fifty-four','55':'fifty-five','56':'fifty-six','57':'fifty-seven','58':'fifty-eight','59':'fifty-nine',
      '60':'sixty','61':'sixty-one','62':'sixty-two','63':'sixty-three','64':'sixty-four','65':'sixty-five','66':'sixty-six','67':'sixty-seven','68':'sixty-eight','69':'sixty-nine',
      '70':'seventy','71':'seventy-one','72':'seventy-two','73':'seventy-three','74':'seventy-four','75':'seventy-five','76':'seventy-six','77':'seventy-seven','78':'seventy-eight','79':'seventy-nine',
      '80':'eighty','81':'eighty-one','82':'eighty-two','83':'eighty-three','84':'eighty-four','85':'eighty-five','86':'eighty-six','87':'eighty-seven','88':'eighty-eight','89':'eighty-nine',
      '90':'ninety','91':'ninety-one','92':'ninety-two','93':'ninety-three','94':'ninety-four','95':'ninety-five','96':'ninety-six','97':'ninety-seven','98':'ninety-eight','99':'ninety-nine'
    };
    const W1 = ['zero','one','two','three','four','five','six','seven','eight','nine'];
    if (n < 10) return `${W1[n]} points.`;
    if (n < 100) return `${W2[String(n).padStart(2,'0')]} points.`;
    const s4 = String(n).padStart(4,'0');
    const a = s4.slice(0,2);
    const b = s4.slice(2);
    const partA = (a === '00') ? '' : W2[a];
    const partB = (b === '00') ? '' : W2[b];
    const phrase = [partA, partB].filter(Boolean).join(' ');
    return `${phrase || 'zero'} points.`;
  }
  async function speakResult(score, {lang='en-US'}={}){
    if (!('speechSynthesis' in window)) return;
    if (!speechReady) {
      await unlockSpeech();
      if (!speechReady) { setTimeout(()=>{ if (speechReady) speakResult(score,{lang}); }, 80); return; }
    }
    const voices = await getVoicesAsync();
    const v = pickPreferredEnFemale(voices);
    const isExcellent = Number(score) >= 7000;
    const formatted = formatScoreTwoDigits(Number(score));
    const text = isExcellent ? `Excellent! ${formatted}` : formatted;
    try{
      if (lastUtter) { try{ speechSynthesis.cancel(); }catch(e){} }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang   = 'en-US';
      utter.rate   = 1.0;
      utter.pitch  = 2;
      utter.volume = 1.0;
      if (v) utter.voice = v;
      lastUtter = utter;
      speechSynthesis.speak(utter);
    }catch(e){ console.warn('TTS failed:', e); }
  }

  // === Voice (or beep) countdown ===
  const USE_VOICE_COUNTDOWN = true; // ビープに戻す場合は false
  const FAST_DIGITS = false; // digits not used now
  const BURST_RATE = 1.15;   // BURST の速さ
  const LIVE_STABILITY = false; // 本番は false（終了後のみ）

  function speakCountdown(label){
    return new Promise(async (resolve)=>{
      const fallback = ()=>{
        const tone = (label==='BURST!') ? 72 : 60;
        ensureAudio().then(()=>{ try{ beep(tone, label==='BURST!'?127:110); }catch(_){} });
        resolve(false);
      };

      if (!USE_VOICE_COUNTDOWN || !('speechSynthesis' in window)) { fallback(); return; }

      try{
        await unlockSpeech();
        const voices = await getVoicesAsync();
        const v = pickPreferredEnFemale(voices);

        const u = new SpeechSynthesisUtterance(String(label).replace('BURST!','Burst'));
        u.lang   = 'en-US';
        u.rate   = (label==='BURST!') ? BURST_RATE : 1.0;
        u.pitch  = 2;
        u.volume = 1.0;
        if (v) u.voice = v;

        let started = false;
        u.onstart = ()=>{ started = true; };
        u.onerror = ()=>{ fallback(); };
        u.onend   = ()=>{ resolve(true); };

        try{ if (speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){ }
        speechSynthesis.speak(u);
        setTimeout(()=>{ if (!started) fallback(); }, 450);
      }catch(e){ fallback(); }
    });
  }

  function startCountdown(){
    if (running || counting) return;
    counting = true;
    resetStats();
    // hide Time Left until BURST is spoken
    const tc=document.getElementById('timeCard'); if(tc) tc.setAttribute('aria-hidden','true');
    document.body.classList.add('playing');
    document.body.classList.add('countdown');

    const overlay = document.getElementById('overlay');
    overlay.classList.add('show');

    (async ()=>{
      overlay.textContent = 'READY';
      await speakCountdown('READY');

      overlay.textContent = 'BURST!';
      await speakCountdown('BURST!');
      if (!counting) return;

      overlay.classList.remove('show');
      overlay.textContent = '';
      counting = false;
      // show Time Left now that run starts
      const tc=document.getElementById('timeCard'); if(tc) tc.removeAttribute('aria-hidden');
      startRun();
    })();
  }

  // ===== Game loop =====
  let timerId=null, endAt=0;
  const DUR_MS = 10000;                 // 10s window
  const TARGET_HITS_10S = 200;          // 100% speed基準
  function startRun(){
    document.body.classList.remove('countdown');
    document.body.classList.add('running');
    running=true; btnStop.disabled=false; btnStart.disabled=true; ts.length=0; lastAccepted=null; ensureAudio();
    const DURATION=DUR_MS;
    const t0=performance.now(); endAt=t0+DURATION;
    const tick=()=>{
      const now=performance.now();
      const left=Math.max(0, endAt-now);
      elTime.textContent=(left/1000).toFixed(2);
      if (left<=0){ finish(); return; }
      timerId=requestAnimationFrame(tick);
    };
    timerId=requestAnimationFrame(tick);
  }

  // ===== Scoring (Hits + Stability bonus) =====
  const SC_HITS_W = 1.0;
  const SC_STAB_W = 1.0;
  const SC_STAB_REF = 0.12;   // 目安CV
  function calcScore(){
    const hits = Number(elHits.textContent)|0;
    const effectiveHits = (mode==='E') ? hits : Math.floor(hits/2)*2; // トリルは偶数で評価
    const cv = calcStability();
    const stabFactor = Math.max(0, (SC_STAB_REF - cv)) / SC_STAB_REF; // 0..1
    const stabBonus = Math.round(effectiveHits * stabFactor * SC_STAB_W);
    const base = Math.round(effectiveHits * SC_HITS_W);
    return Math.max(0, base + stabBonus);
  }

  function finish(){
    if(timerId){ cancelAnimationFrame(timerId); timerId=null; }
    running=false; counting=false; btnStop.disabled=true; btnStart.disabled=false; body.classList.remove('playing'); document.body.classList.remove('running'); document.getElementById('timeCard')?.setAttribute('aria-hidden','true');

    // === Original-style scoring ===
    const N = ts.length;
    const dur = (ts.length>=1? (Math.max(1, (ts.at(-1) - ts[0]))/1000) : 0);
    const sec = Math.min(DUR_MS/1000, Math.max(0.001, dur));
    const hps = N / sec;

    const elSpeed = document.getElementById('speed');
    if (elSpeed) elSpeed.textContent = hps.toFixed(2);

    let stab = 0;
    if(N>=2){
      const dt=[]; for(let i=1;i<N;i++) dt.push(ts[i]-ts[i-1]);
      const mu = dt.reduce((a,b)=>a+b,0)/dt.length;
      const sd = Math.sqrt(dt.reduce((s,x)=>s+(x-mu)*(x-mu),0)/dt.length);
      stab = Math.max(0, Math.min(1, 1 - (sd/(mu||1))));
      elStab.textContent = stab.toFixed(3);
      const speedScore = Math.max(0, Math.min(100, (N / TARGET_HITS_10S) * 100));
      const stabScore  = stab * 100;
      scoreNum = Math.round(speedScore * stabScore);
      renderScore();
    }else{
      elStab.textContent = '0.000';
      scoreNum = 0; renderScore();
    }

    // === Populate and show result modal ===
    rHits.textContent = String(N);
    rStab.textContent = (typeof stab==='number'? stab.toFixed(3) : '0.000');
    rScore.textContent = String(scoreNum).padStart(4,'0');
    resultModal.classList.add('show');

    speakResult(scoreNum||0);
    resetKeyVisuals();
  }

  // ===== Tap logic =====
  function noteFromPos(evt){
    const r = area.getBoundingClientRect();
    const x = (evt.clientX ?? (evt.touches && evt.touches[0] && evt.touches[0].clientX) ?? r.left);
    const ratio = (x - r.left) / Math.max(1, r.width);
    return (ratio < 0.5) ? 60 : 62; // left:C(60), right:D(62)
  }
  function tapToNote(evt){
    const n = noteFromPos(evt);
    if (mode==='E'){
      if (n!==60) return null; // C のみ
    } else if (mode==='D'){
      if (lastAccepted===n) return null; // トリル（交互）
    }
    return { note:n };
  }

  function onDown(evt){
    if(!running) return;
    const res = tapToNote(evt);
    if(!res) return;
    lastAccepted = res.note;
    ts.push(performance.now());
    elHits.textContent = String(Number(elHits.textContent)+1);
    if (LIVE_STABILITY) updateStability();
    setKeyVisual(res.note, true);
    ensureAudio().then(()=>{
      audioUnlocked = !!(audio && audio.state === 'running');
      beep(res.note, 115);
    });
  }
  function onUp(evt){
    if(!running) return;
    const n = noteFromPos(evt);
    setKeyVisual(n, false);
  }
  document.getElementById('pianoArea').addEventListener('pointerdown', onDown);
  window.addEventListener('pointerup', onUp);

  // Buttons
  btnStart.addEventListener('click', ()=> startCountdown());
  btnStop.addEventListener('click', ()=> finish());
  btnCloseResult.addEventListener('click', ()=>{ resultModal.classList.remove('show'); });
  resultModal.addEventListener('click', (e)=>{ if(e.target===resultModal) resultModal.classList.remove('show'); });

  // ==== iOS Safari: prevent tap-zoom & dblclick zoom ====
  (function preventIOSZoom(){
    const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    if(!isiOS) return;

    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouchEnd <= 350) { e.preventDefault(); }
      lastTouchEnd = now;
    }, {passive:false});

    document.addEventListener('dblclick', (e)=>{ e.preventDefault(); }, {capture:true});

    document.querySelectorAll('label, button').forEach(el=>{
      const fs = parseFloat(getComputedStyle(el).fontSize);
      if (fs && fs < 16) el.style.fontSize = '16px';
    });
  })();

  // ===== Developer tests =====
  (function runDevTests(){
    if(!/[?&]test=1\b/.test(location.search)) return;
    console.log('[tests] start');
    const r = document.getElementById('pianoArea').getBoundingClientRect ? document.getElementById('pianoArea').getBoundingClientRect() : {left:0,width:100};
    // E mode: only C accepted
    mode='E'; lastAccepted=null;
    console.assert((tapToNote({clientX:r.left+0.1*r.width, pressure:1})||{}).note===60, 'E:C left ok');
    console.assert(tapToNote({clientX:r.left+0.9*r.width, pressure:1})===null, 'E:D right ignored');
    // D mode: alternate required
    mode='D'; lastAccepted=60;
    console.assert(tapToNote({clientX:r.left+0.1*r.width, pressure:1})===null, 'D:C repeat ignored');
    lastAccepted=60; console.assert((tapToNote({clientX:r.left+0.9*r.width, pressure:1})||{}).note===62, 'D:D accepted after C');
    // noteFromPos helper
    const nn = noteFromPos({clientX:r.left+0.75*r.width});
    console.assert(nn===62, 'noteFromPos right→D');
    console.log('[tests] ok');
  })();
  </script>
</body>
</html>
