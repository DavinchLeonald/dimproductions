<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="preload" href="https://dim.productions/assets/fonts/PressStart2P.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="canonical" href="https://dim.productions/pianovirtuoso18">
  <title>Piano Virtuoso 18</title>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%; overscroll-behavior: none; touch-action: manipulation; -webkit-text-size-adjust: 100%; overflow-x:hidden;}
    body{-webkit-touch-callout:none;-webkit-user-select:none}
    @font-face{
      font-family:'Press Start 2P';
      src:url('https://dim.productions/assets/fonts/PressStart2P.woff2') format('woff2'),
          url('/assets/fonts/PressStart2P.woff2') format('woff2');
      font-style:normal;font-weight:400;font-display:swap;
    }
    body{margin:0;background:#000;color:#fff;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;text-align:center;font-synthesis:none}
    .wrap{max-width:800px;margin:0 auto;padding:16px;overflow-x:hidden}
    h1{font:700 18px/1.2 'Press Start 2P',monospace;margin:6px 0 12px;letter-spacing:.5px}
    #overlay,.big,.segments label{font-family:'Press Start 2P',monospace}
    .card>div:first-child{font-family:'Press Start 2P',monospace;font-weight:700;letter-spacing:.3px}

    .controls{display:flex;flex-direction:column;gap:12px;align-items:center}
    .segments{display:flex;gap:10px}
    .segments label{ padding:8px 12px; cursor:pointer; background:transparent; font-size:16px;      /* 追加：iOSフォーカス時のズーム抑止 */ line-height:1.2;     /* 追加：行高整える */ }
    .segments input{display:none}
    .segments input:checked+label{background:#b5001e;color:#000}

    .btnRow{display:flex;gap:var(--btn-gap,10px);justify-content:center;flex-wrap:nowrap;align-items:center;overflow:visible;padding:2px 4px}
    @media (max-width:380px){ .btnRow{ flex-wrap: wrap; gap: var(--btn-gap); } }
    button{ padding:0; border:none; background:transparent; cursor:pointer; margin:0; line-height:0; }
    .svgBtn{display:inline-grid;place-items:center;touch-action:manipulation;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
    .svgBtn .icon{width:clamp(var(--btn-icon-min), var(--btn-icon-vw), var(--btn-icon-max));height:auto;transition:filter .25s ease, transform .06s;overflow:visible}
    .svgBtn .icon use{transition:filter .25s ease}
    .svgBtn.pressed .icon{transform:translateY(3px) scale(.98)}

    /* 初期状態: start青く光る, stop消灯 */
    #btnStart .icon{filter:drop-shadow(0 0 10px rgba(0,180,255,.9)) drop-shadow(0 0 25px rgba(0,180,255,.6));}
    #btnStop .icon{filter:none;opacity:0.6}

    /* プレイ中（start押下→stop有効）: stop赤く光り、start消灯 */
    body.playing #btnStart .icon{filter:none;opacity:0.6}
    body.playing #btnStop .icon{filter:drop-shadow(0 0 10px rgba(255,60,60,.9)) drop-shadow(0 0 25px rgba(255,0,0,.6));opacity:1}

    .card{background:#111;padding:10px;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .big{font-weight:700;font-size:20px;line-height:1.1;font-family:'Press Start 2P',monospace}

    #pianoArea{display:flex;justify-content:center;align-items:center;margin:12px auto 18px;max-width:100%;user-select:none;-webkit-user-select:none;touch-action:none;overscroll-behavior:contain;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;}
    #pianoArea svg{display:block;width:clamp(220px,72vw,420px);max-height:38vh;height:auto;margin:0 auto;}
    @media (min-width:768px){#pianoArea svg{width:clamp(360px,70vw,560px);}}
    .spacer-md{height:12px}
    .key{display:flex;align-items:center;justify-content:center;transition:transform .06s ease, filter .06s ease}
    .key.down{transform:translateY(2px) scaleY(.985); filter:brightness(1.15)}
    .glow-black{filter:drop-shadow(0 0 10px rgba(0,0,0,.95)) drop-shadow(0 0 26px rgba(0,0,0,.85)) brightness(.85) contrast(1.1);} 
    .key .label{opacity:.6; font-weight:700}
    .key:active{filter:brightness(1.2)}

    #overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.5);color:#ff5050;font:700 clamp(40px,10vw,120px)/1 'Press Start 2P',monospace;opacity:0;pointer-events:none;transition:.15s;z-index:2147483647;will-change:opacity}
    #overlay.show{opacity:1}

    :root{
      --btn-gap: 10px;
      --btn-icon-min: 220px;
      --btn-icon-vw: 36vw;
      --btn-icon-max: 300px;
    }
  </style>
</head>
<body>
  <!-- Inline SVG symbols so <use> works locally -->
  <svg  style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="btn-start" viewBox="0 0 195.83154 45.981833">
      <g transform="translate(-184.87527,-0.433794)">
        <path fill="#1a1a1a" d="m 214.36793,41.837793 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-28.970979 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.2002 l 0.0238,4.14 h 4.07204 l 0.0238,4.1439 h 4.144 l -0.0238,28.972159 h -4.144 l 0.0238,4.1439 h -4.14358 l 0.024,4.144 h -32.9612 z"/>
        <path fill="#000055" d="m 214.34407,37.693753 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-24.831019 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.1999 l 0.0238,4.14 h 4.1442 l 0.0238,4.1439 h 4.096 l -0.0238,24.832199 h -4.096 l 0.0238,4.1439 h -4.1919 l 0.024,4.144 h -32.98474 z"/>
        <path fill="#0000aa" d="m 214.32037,33.553753 h -4.12016 l -0.1438,-24.839999 h 4.12016 l -0.0238,-4.14 h 33.2002 l 0.0238,4.14 h 4.12014 l -0.0954,24.839999 h -4.12014 l 0.0238,4.14 h -32.9612 z"/>
        <path fill="#0000ff" d="m 214.32037,33.553753 -0.1438,-24.839999 h 33.2002 l -0.0954,24.839999 z"/>
        <path fill="#00ccff" d="m 218.32104,25.269853 h -4.09615 l -0.0483,-16.556099 4.12007,-2e-5 v -4.13998 h 24.91201 v 4.13998 l 4.16774,-3.4e-4 v 16.560359 h -4.17964 l 0.0238,4.14 -24.87589,-0.004 z"/>
        <path fill="#000" d="m 226.51306,14.933357 h 12.384 v 4.144397 h -4.12016 l 0.012,2.072 h -4.12016 l -0.0358,2.072 h -4.12016 z"/>
        <path fill="#0000ff" d="m 226.51267,8.717754 h 4.13231 l -0.012,2.072 h 4.12016 l 0.0119,2.072 h 4.13202 v 4.144 h -4.10811 l 0.012,2.072 h -4.12016 l -0.0358,2.072 h -4.13231 z"/>
      </g>
    </symbol>
    <symbol id="btn-stop" viewBox="0 0 195.83154 45.981833">
      <g transform="translate(-286.97479,90.724357)">
        <path fill="#1a1a1a" d="m 417.06275,-49.320358 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-28.970979 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.20052 l 0.0238,4.14 h 4.09623 l 0.0238,4.1439 h 4.144 l -0.0238,28.972159 h -4.144 l 0.0238,4.1439 h -4.16777 l 0.024,4.144 h -32.96152 z"/>
        <path fill="#550000" d="m 417.03889,-53.464398 -4.12,0.002 -0.0238,-4.14196 -4.12004,-9.8e-4 -0.1418,-24.831019 4.11808,-0.008 -0.0238,-4.14 h 4.12016 l -0.024,-4.14 h 33.2002 l 0.0238,4.14 h 4.12041 l 0.0238,4.1439 h 4.144 l -0.0238,24.832199 h -4.144 l 0.0238,4.1439 h -4.19195 l 0.024,4.144 h -32.9612 z"/>
        <path fill="#aa0000" d="m 417.01519,-57.604398 h -4.12016 l -0.1438,-24.839999 h 4.12016 l -0.0238,-4.14 h 33.2002 l 0.0238,4.14 h 4.15611 l -0.0954,24.839999 h -4.15611 l 0.0238,4.14 h -32.9612 z"/>
        <path fill="#d40000" d="m 417.01519,-57.604398 -0.1438,-24.839999 h 33.2002 l -0.0954,24.839999 z"/>
        <path fill="#ff8080" d="m 421.03987,-65.888298 h -4.12016 l -0.0483,-16.556099 4.1678,-2e-5 -0.0238,-4.13998 h 24.8646 l 0.0238,4.13998 4.16742,-3.4e-4 v 16.560359 h -4.31042 l 0.0238,4.14 -24.7211,-0.004 z"/>
        <path fill="#000" d="m 312.75358,22.78496 v -2.072 h 12.36215 l -3e-4,2.072 z" transform="translate(114.60833,-90.724357)"/>
        <path fill="#aa0000" d="m 312.75354,20.71296 -0.071,-12.433 h 12.36124 l 0.0718,12.433 z" transform="translate(114.60833,-90.724357)"/>
      </g>
    </symbol>
  </svg>

  <div class="wrap">
    <h1></h1>
    <div class="controls">
      <div class="segments">
        <input id="modeE" type="radio" name="mode" value="E" checked>
        <label for="modeE">Erlkönig</label>
        <input id="modeD" type="radio" name="mode" value="D">
        <label for="modeD">Diavolo</label>
      </div>
      <div class="btnRow">
        <button id="btnStart" class="svgBtn" aria-label="Start">
          <svg class="icon" viewBox="0 0 195.83154 45.981833"><use href="#btn-start"></use></svg>
        </button>
        <button id="btnStop" class="svgBtn" aria-label="Stop" disabled>
          <svg class="icon" viewBox="0 0 195.83154 45.981833"><use href="#btn-stop"></use></svg>
        </button>
      </div>
    </div>

    <div class="card">
      <div>TIME LEFT (s)</div>
      <div class="big" id="timeLeft">10.00</div>
    </div>

    <div id="pianoArea">
      <!-- === Light, precise SVG (IDs preserved; positions unchanged) === -->
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   width="276.40063"
   height="290.09927"
   viewBox="0 0 73.131003 76.755435"
   version="1.1"
   id="piano"
   xml:space="preserve"
   inkscape:version="1.4.2 (f4327f4, 2025-05-13)"
   sodipodi:docname="piano18.svg"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg"><sodipodi:namedview
   id="namedview1"
   pagecolor="#505050"
   bordercolor="#eeeeee"
   borderopacity="1"
   inkscape:showpageshadow="0"
   inkscape:pageopacity="0"
   inkscape:pagecheckerboard="0"
   inkscape:deskcolor="#505050"
   inkscape:document-units="mm"
   showgrid="false"
   showguides="false"
   inkscape:zoom="1.8"
   inkscape:cx="149.44444"
   inkscape:cy="201.94444"
   inkscape:window-width="1920"
   inkscape:window-height="1009"
   inkscape:window-x="-8"
   inkscape:window-y="-8"
   inkscape:window-maximized="1"
   inkscape:current-layer="bg"
   inkscape:lockguides="false"
   inkscape:antialias-rendering="false"><inkscape:grid
     id="grid1"
     units="mm"
     originx="-305.69025"
     originy="8.5270882"
     spacingx="0.99999998"
     spacingy="1"
     empcolor="#0099e5"
     empopacity="0.30196078"
     color="#0099e5"
     opacity="0.14901961"
     empspacing="5"
     enabled="true"
     visible="false" /></sodipodi:namedview><defs
   id="defs1"><rect
     x="18.738329"
     y="-67.17514"
     width="301.9346"
     height="36.76955"
     id="rect9" /><rect
     x="283.46451"
     y="-1455.118"
     width="1606.2992"
     height="737.00787"
     id="rect11" /><rect
     x="-1401.0012"
     y="-2249.3853"
     width="5954.2554"
     height="1969.1851"
     id="rect10" /><rect
     x="283.46451"
     y="-1455.118"
     width="1606.2992"
     height="737.00787"
     id="rect11-1" /><rect
     x="283.46451"
     y="-1455.118"
     width="1606.2992"
     height="737.00787"
     id="rect11-1-2" /><rect
     x="310.77344"
     y="-315.72318"
     width="215.31401"
     height="88.034798"
     id="rect5846-0" /><rect
     x="310.77344"
     y="-315.72318"
     width="215.31401"
     height="88.034798"
     id="rect5846" /><rect
     x="533.15851"
     y="-395.97977"
     width="421.43561"
     height="165.46298"
     id="rect1-7" /><rect
     x="533.15851"
     y="-395.97977"
     width="421.43561"
     height="165.46298"
     id="rect1-2" /><rect
     x="18.738329"
     y="-67.17514"
     width="301.9346"
     height="36.76955"
     id="rect9-5" /></defs><g
   inkscape:groupmode="layer"
   id="bg"
   inkscape:label="piano"
   pointer-events="none"
   transform="matrix(1.5,0,0,1.5,-115.116,-6.3940749)">
  <!-- FRAME ONLY (kept). No keys inside this group. -->
  <path
   style="display:inline;fill:#000000;stroke-width:1.44874;stroke-linejoin:bevel"
   d="M 76.744203,4.2646566 125.498,4.263 v 51.168104 l -24.37084,9.5e-4 -24.38316,9.5e-4 z"
   id="path1" />
  <path
   id="rect2-9"
   style="display:inline;fill:#1a1a1a;stroke-width:8.7184;stroke-linejoin:bevel"
   d="m 80.398296,51.774947 41.453594,-0.0019 v 2.436 l -41.453594,0.0019 z M 124.28,5.4807167 124.288,55.428899 h -1.21811 l -4.9e-4,-48.7310989 -43.889197,0.003 9.3e-5,48.7303039 -1.218093,-2.65e-4 V 5.4826551 Z m -2.42813,43.8580503 -4.87301,2.65e-4 2e-4,-32.894964 -31.707562,0.0026 -5.3e-4,32.894422 h -4.8726 l -1.3e-4,-41.422162 41.453392,-0.00186 z" />
  <path
   id="rect5-9-6-4-7-6"
   style="display:inline;fill:#4d4d4d;stroke-width:0.247543;stroke-linejoin:bevel"
   d="m 80.402919,40.812065 3.65473,-6.65e-4 v 2.43645 l -3.65473,6.65e-4 z m 37.786051,-0.0017 3.65473,-6.51e-4 v 2.43645 l -3.65473,6.51e-4 z" />
  <path
   id="rect5-9-6-4-7-2-8"
   style="display:inline;fill:#666666;stroke-width:0.247543;stroke-linejoin:bevel"
   d="m 80.402919,38.37393 h 3.65473 v 2.43747 l -3.65473,6.65e-4 z m 37.786051,-1.5e-5 3.65473,1.5e-5 v 2.435784 l -3.65473,6.51e-4 z" />
  <path
   id="rect2-5-1-0-79-6"
   style="display:inline;fill:#e6e6e6;stroke-width:0.255661;stroke-linejoin:bevel"
   d="m 107.20368,43.24785 9.76318,0.0013 v 2.43645 l -9.76318,-2.17e-4 z"
   sodipodi:nodetypes="ccccc" />
  <path
   id="rect3"
   style="display:inline;fill:#f4eed7;stroke-width:2.0312;stroke-linejoin:bevel"
   d="m 107.20368,45.6864 9.76318,-8.28e-4 v 4.869921 l -9.76286,5.57e-4 z"
   sodipodi:nodetypes="ccccc" />
  <path
   id="rect3-86"
   style="display:inline;fill:#ffffff;stroke-width:2.27144;stroke-linejoin:bevel"
   d="m 107.2038,18.883275 10.98553,-0.0014 7e-5,24.365167 -10.9854,0.0019 z"
   sodipodi:nodetypes="ccccc" />
  <path
   id="rect1-76"
   style="display:inline;fill:#333333;stroke-width:1.45761;stroke-linejoin:bevel"
   d="m 125.498,4.2627166 h -2.436 v 1.2180001 h 1.218 v 1.218 h 1.218 z m -48.754,0.00194 h 2.436203 V 5.482652 h -1.218 v 1.218 h -1.218 z m 3.658895,6.0909014 41.439125,-10e-4 v 2.43645 l -41.439125,10e-4 z m 2.4e-5,32.892957 3.65473,-6.58e-4 v 2.43645 l -3.65473,6.58e-4 z m 37.786051,-0.0017 3.65473,-6.58e-4 v 2.43645 l -3.65473,6.58e-4 z m -37.786051,-7.307699 3.65473,-6.58e-4 v 2.435472 h -3.65473 z m 37.786051,-0.0017 3.65473,-6.58e-4 v 2.437172 l -3.65473,-6.4e-5 z" />
  <path
   id="rect5-2-7"
   style="display:inline;fill:#800000;stroke-width:0.805306;stroke-linejoin:bevel"
   d="m 85.275395,17.664276 31.691145,-6.02e-4 -2.9e-4,1.218223 -31.690855,6.02e-4 z" />
  <path
   id="rect5-9-6-4-1-8"
   style="display:inline;fill:#000000;stroke-width:1.44874;stroke-linejoin:bevel"
   d="M 79.198598,15.227826 H 123.0694 v 2.43645 H 79.198598 Z m 37.767442,2.435853 h 1.223 l 3.6e-4,32.891814 h -1.22254 z m -32.908755,5.97e-4 h 1.21811 l 3.64e-4,9.545464 v 23.346351 h -1.21811 z"
   sodipodi:nodetypes="cccccccccccccccc" />
</g>

<g
   id="keys"
   transform="matrix(1.5,0,0,1.5,-115.116,-6.3940749)"
   style="display:inline">
  <!-- Keys share the same base transform as the frame so they render in place -->
  <g
   id="C1up"
   transform="matrix(0.64971999,0,0,0.42231802,0.81216,-8.3245269)"
   style="display:inline">
    <path
   fill="#ffffff"
   d="m 130,64.423065 h 14.99723 V 122.12035 H 130 Z"
   id="path2" />
    <path
   fill="#e6e6e6"
   d="m 130,122.12035 h 14.99723 v 5.76923 H 130 Z"
   id="path3" />
    <path
   fill="#f4eed7"
   d="m 130,127.88958 14.99723,0.001 V 139.423 H 130 Z"
   id="path4" />
    <path
   fill="#000000"
   d="m 139.37327,101.92456 5.72151,-3e-4 v 2.88408 l -5.72151,-0.001 z"
   id="path5"
   sodipodi:nodetypes="ccccc" />
  </g>
  <g
   id="D1up"
   transform="matrix(0.64972004,0,0,0.42231802,11.77619,-8.5681719)"
   style="display:inline">
    <path
   fill="#ffffff"
   d="m 130,65 h 15 v 57.69834 h -15 z"
   id="path6"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#e6e6e6"
   d="m 130,122.69834 h 15 v 5.76777 h -15 z"
   id="path7"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#f4eed7"
   d="m 130,128.46757 h 15 v 11.53242 h -15 z"
   id="path8"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#000000"
   d="m 130,102.50136 1.87086,-0.001 v 2.88408 L 130,105.38544 Z"
   id="path9"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#000000"
   d="m 143.11388,102.50306 h 3.77348 v 2.88092 h -3.77348 z"
   id="path10"
   sodipodi:nodetypes="ccccc" />
  </g>
  <g
   id="C1down"
   transform="matrix(0.64972001,0,0,0.42231802,0.8130748,-8.2494803)"
   style="display:none">
    <path
   fill="#ffffff"
   d="m 129.99728,64.243863 14.99854,0.0015 3.7e-4,66.346607 h -14.99723 z"
   id="path11"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#e6e6e6"
   d="m 129.99863,130.59197 h 14.99756 l 3.2e-4,5.76922 -14.99722,-0.002 z"
   id="path12"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#e9ddaf"
   d="m 129.99959,136.36119 14.99626,0.002 3.4e-4,2.88253 h -14.9966 z"
   id="path13"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#000000"
   d="m 139.37517,101.74556 h 5.62445 v 5.76816 h -5.62445 z"
   id="path14" />
    <path
   fill="#333333"
   d="m 141.25033,101.74475 3.74929,0.001 v 2.88308 l -3.74929,-10e-4 z"
   id="path15" />
  </g>
  <g
   id="D1down"
   transform="matrix(-0.65075372,0,0,0.42231802,190.5952,-8.3229698)"
   style="display:none">
    <path
   fill="#ffffff"
   d="M 130.02398,64.425958 145,64.423065 v 66.348105 h -14.97602 z"
   id="path16" />
    <path
   fill="#e6e6e6"
   d="M 130.02398,130.77117 145,130.76923 v 5.76922 l -14.97602,0.002 z"
   id="path17" />
    <path
   fill="#e9ddaf"
   d="M 130.02398,136.53985 145,136.53845 v 2.88023 h -14.97602 z"
   id="path18"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#000000"
   d="m 143.12614,101.91957 1.86475,-0.003 0.009,5.77574 -1.87375,-0.001 z"
   id="path19"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#000000"
   d="m 128.14556,101.9273 3.74335,0.002 v 5.76416 l -3.74335,-0.002 z"
   id="path20"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#333333"
   d="m 128.14556,101.92245 h 1.84643 v 2.87934 h -1.84643 z"
   id="path21"
   style="stroke-width:0.993343"
   sodipodi:nodetypes="ccccc" />
    <path
   fill="#333333"
   d="m 144.99819,101.91656 1.87065,-0.006 v 2.87651 l -1.87065,0.006 z"
   id="path22"
   style="stroke-width:0.997639" />
  </g>
</g>
  <!-- Bring black keys to topmost layer -->
  <g
   id="bk-top"
   pointer-events="none"
   transform="matrix(1.5,0,0,1.5,-115.116,-6.3940749)">
    <g
   id="g3-93-1-2-8-7-1-9"
   style="display:inline"
   transform="matrix(0.60911264,0,0,0.37263356,15.261809,-5.3386809)">
      <path
   id="rect1-4-8-6-8-1-4-2"
   style="display:inline;opacity:1;fill:#000000;stroke-width:1.12249;stroke-linejoin:bevel"
   d="m 124.94233,64.999983 9.99745,2.3e-5 V 107.5002 h -9.99805 z"
   sodipodi:nodetypes="ccccc" />
      <path
   id="rect3-1-4-3-4-7-6-0"
   style="display:inline;fill:#333333;stroke-width:4.75835;stroke-linejoin:bevel"
   d="m 126.94529,65.001332 5.9989,1.7e-5 v 42.500191 h -5.9989 z"
   sodipodi:nodetypes="ccccc" />
      <path
   id="rect3-1-6-8"
   style="display:inline;fill:#4d4d4d;stroke-width:4.7327;stroke-linejoin:bevel"
   d="m 126.94531,65.000637 h 1.9998 l 1e-5,32.692319 3.98921,2.15e-4 v 3.269009 l -5.98904,-2.1e-4 z" />
    </g>
    <g
   id="g3-93-1-2-8-7-1-9-5"
   style="display:inline"
   transform="matrix(0.60911264,0,0,0.37263356,28.662105,-5.3375688)">
      <path
   id="rect1-4-8-6-8-1-4-2-5"
   style="opacity:1;fill:#000000;stroke-width:1.12246;stroke-linejoin:bevel"
   d="M 124.94552,64.999977 134.94358,65 v 45.76591 h -5.9988 v -3.25968 h -3.99926 z"
   sodipodi:nodetypes="ccccccc" />
      <path
   id="rect3-1-4-3-4-7-6-0-1"
   style="display:inline;fill:#333333;stroke-width:4.75835;stroke-linejoin:bevel"
   d="m 126.94529,64.99998 5.9989,1.7e-5 v 42.500863 l -5.9989,-8.8e-4 z"
   sodipodi:nodetypes="ccccc" />
      <path
   id="rect3-1-6-8-7"
   style="display:inline;fill:#4d4d4d;stroke-width:4.7327;stroke-linejoin:bevel"
   d="m 126.94506,65.000646 h 1.9998 l 1e-5,32.692319 3.98921,2.15e-4 v 3.26901 l -5.98904,-2.1e-4 z" />
    </g>
  </g>
</svg>


    </div>

    <div class="grid">
      <div class="card"><div>HITS</div><div id="hits" class="big">0</div></div>
      <div class="card"><div>STABILITY</div><div id="stability" class="big">0.000</div></div>
      <div class="card"><div>SCORE</div><div id="score" class="big">0</div></div>
    </div>
  </div>
  <div id="overlay"></div>

  <script>
  // ===== Tap-only minimal engine (no modules; browser-safe) =====
  const btnStart=document.getElementById('btnStart');
  const btnStop=document.getElementById('btnStop');
  const body=document.body;
  const elHits=document.getElementById('hits');
  const elStab=document.getElementById('stability');
  const elScore=document.getElementById('score');
  const elTime=document.getElementById('timeLeft');
  const area=document.getElementById('pianoArea');

  function swapSvgVisibility(upId, downId, isDown){
    const up = document.getElementById(upId);
    const dn = document.getElementById(downId);
    if(!up && !dn) return;
    if(up)  up.style.display = isDown ? 'none'  : 'inline';
    if(dn)  dn.style.display = isDown ? 'inline': 'none';
  }
  function pressPath(note){
  return document.querySelector(note===60 ? '#C1down path' : '#D1down path');
}
function setKeyVisual(note, isDown){
    if(note===60){
      swapSvgVisibility('C1up','C1down',!!isDown);
      const p = pressPath(60);
      if(p) p.classList.toggle('glow-black', !!isDown);
    }
    if(note===62){
      swapSvgVisibility('D1up','D1down',!!isDown);
      const p = pressPath(62);
      if(p) p.classList.toggle('glow-black', !!isDown);
    }
  }
  function resetKeyVisuals(){
  swapSvgVisibility('C1up','C1down',false);
  swapSvgVisibility('D1up','D1down',false);
  const pC = pressPath(60); if(pC) pC.classList.remove('glow-black');
  const pD = pressPath(62); if(pD) pD.classList.remove('glow-black');
}

  let running=false,counting=false,ts=[]; let scoreNum=0; // timestamps (ms)
  let mode='E';
  let lastAccepted=null;
  Array.from(document.querySelectorAll('input[name="mode"]')).forEach(r=>{
    r.onchange = async (e)=>{
      mode=r.value; lastAccepted=null; resetKeyVisuals();
      if (e && e.isTrusted) { try{ await ensureAudio(); }catch(_){ }
        const noteMap = { E:60, D:62 };
        const midi = noteMap[r.value] || 60; beep(midi, 110);
      }
    };
  });

  function flash(btn){ btn.classList.add('pressed'); setTimeout(()=>btn.classList.remove('pressed'),120); }
  btnStart.addEventListener('pointerdown', ()=> flash(btnStart));
  btnStop .addEventListener('pointerdown', ()=> flash(btnStop));

  function renderScore(){ elScore.textContent = String(scoreNum).padStart(4,'0'); }
function renderScore(){ elScore.textContent = String(scoreNum).padStart(4,'0'); }
function calcIntervals(arr){
  if (!arr || arr.length < 2) return [];
  const out=[]; for(let i=1;i<arr.length;i++) out.push(arr[i]-arr[i-1]);
  return out;
}
function calcStability(){
  const iv = calcIntervals(ts);
  if (iv.length < 2) return 0;
  const mu = iv.reduce((a,b)=>a+b,0)/iv.length;
  const sd = Math.sqrt(iv.reduce((s,x)=>s+(x-mu)*(x-mu),0)/iv.length);
  // original-style stability: 1 - sd/mu, clamped to 0..1
  const stab = Math.max(0, Math.min(1, 1 - (sd/(mu||1))));
  return stab; // 0..1 (higher is better)
}
function updateStability(){
  const stab = calcStability();
  elStab.textContent = stab.toFixed(3);
}
function resetStats(){
  ts.length=0; scoreNum=0;
  elHits.textContent='0';
  elStab.textContent='0.000';
  renderScore();
  elTime.textContent='10.00';
}

  // ===== Audio =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let audio = null;
  let audioUnlocked = false;

  async function ensureAudio(){
    if (!AC) return null;
    if (!audio || audio.state === 'closed'){
      audio = new AC({ latencyHint: 'interactive' });
      try{
        const g = audio.createGain(); g.gain.value = 1; g.connect(audio.destination);
        const buf = audio.createBuffer(1, 32, audio.sampleRate);
        const src = audio.createBufferSource(); src.buffer = buf; src.connect(g);
        src.start(audio.currentTime + 0.002);
      }catch(e){}
    }
    if (audio.state === 'suspended'){
      try{ await audio.resume(); }catch(e){ console.warn('resume failed', e); }
    }
    audioUnlocked = !!(audio && audio.state === 'running');
    return audio;
  }

  window.addEventListener('click', async () => {
    await ensureAudio();
    audioUnlocked = true;
  }, { once: true });

  window.addEventListener('keydown', async () => {
    if (!audioUnlocked) { await ensureAudio(); audioUnlocked = true; }
  }, { once:true });

  let muted = false;  // テスト用ミュート
  function setMuted(on){
    muted = !!on; document.body.classList.toggle('muted', muted);
  }
  function toggleMuted(){ setMuted(!muted); }
  if (location.search.includes('mute=1')) setMuted(true);

  function beep(midi, vel = 100){
    if (!audioUnlocked || !audio || muted) return;
    const t0 = audio.currentTime, len = 0.08;
    const osc = audio.createOscillator();
    const g = audio.createGain();
    osc.type = 'square';
    osc.frequency.value = 440 * Math.pow(2,(midi-69)/12);
    const v = Math.max(0.08, Math.min(1, vel/127));
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.linearRampToValueAtTime(0.25*v, t0+0.003);
    g.gain.linearRampToValueAtTime(0.0001, t0+len);
    osc.connect(g).connect(audio.destination);
    osc.start(t0);
    osc.stop(t0+len);
  }

  // ========= Speech (female voice + Excellent >= 7000) =========
  async function getVoicesAsync(){
    if (!('speechSynthesis' in window)) return [];
    const have = speechSynthesis.getVoices();
    if (have && have.length) return have;
    return new Promise(res=>{
      const onv = ()=>{ speechSynthesis.removeEventListener('voiceschanged', onv); res(speechSynthesis.getVoices()||[]); };
      speechSynthesis.addEventListener('voiceschanged', onv);
      setTimeout(()=>res(speechSynthesis.getVoices()||[]), 500);
    });
  }
  function pickPreferredEnFemale(voices){
    if (!voices || !voices.length) return null;
    const femaleHints = /(samantha|victoria|karen|zira|aria|ana|female|google.*english.*female)/i;
    const enUS = voices.filter(v => /en[-_]US/i.test(v.lang||''));
    const hit = enUS.find(v => femaleHints.test(`${v.name} ${v.voiceURI}`));
    if (hit) return hit;
    if (enUS[0]) return enUS[0];
    const enAny = voices.find(v => /^en[-_]/i.test(v.lang||''));
    return enAny || voices[0] || null;
  }
  let speechReady = false;
  let lastUtter = null;
  async function unlockSpeech(){
    if (!('speechSynthesis' in window) || speechReady) return;
    await getVoicesAsync();
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('');
      u.lang = 'en-US';
      u.volume = 0; // 無音
      u.onend = ()=>{ speechReady = true; };
      speechSynthesis.speak(u);
    }catch(e){}
  }
  window.addEventListener('pointerdown', unlockSpeech, { once:true });
  window.addEventListener('keydown',     unlockSpeech, { once:true });
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'visible' && 'speechSynthesis' in window){
      try{ speechSynthesis.resume(); }catch(e){}
    }
  });

  function formatScoreTwoDigits(score){
    const n = Math.max(0, Number(score)|0);
    const W2 = {
      '00':'zero','01':'one','02':'two','03':'three','04':'four','05':'five','06':'six','07':'seven','08':'eight','09':'nine',
      '10':'ten','11':'eleven','12':'twelve','13':'thirteen','14':'fourteen','15':'fifteen','16':'sixteen','17':'seventeen','18':'eighteen','19':'nineteen',
      '20':'twenty','21':'twenty-one','22':'twenty-two','23':'twenty-three','24':'twenty-four','25':'twenty-five','26':'twenty-six','27':'twenty-seven','28':'twenty-eight','29':'twenty-nine',
      '30':'thirty','31':'thirty-one','32':'thirty-two','33':'thirty-three','34':'thirty-four','35':'thirty-five','36':'thirty-six','37':'thirty-seven','38':'thirty-eight','39':'thirty-nine',
      '40':'forty','41':'forty-one','42':'forty-two','43':'forty-three','44':'forty-four','45':'forty-five','46':'forty-six','47':'forty-seven','48':'forty-eight','49':'forty-nine',
      '50':'fifty','51':'fifty-one','52':'fifty-two','53':'fifty-three','54':'fifty-four','55':'fifty-five','56':'fifty-six','57':'fifty-seven','58':'fifty-eight','59':'fifty-nine',
      '60':'sixty','61':'sixty-one','62':'sixty-two','63':'sixty-three','64':'sixty-four','65':'sixty-five','66':'sixty-six','67':'sixty-seven','68':'sixty-eight','69':'sixty-nine',
      '70':'seventy','71':'seventy-one','72':'seventy-two','73':'seventy-three','74':'seventy-four','75':'seventy-five','76':'seventy-six','77':'seventy-seven','78':'seventy-eight','79':'seventy-nine',
      '80':'eighty','81':'eighty-one','82':'eighty-two','83':'eighty-three','84':'eighty-four','85':'eighty-five','86':'eighty-six','87':'eighty-seven','88':'eighty-eight','89':'eighty-nine',
      '90':'ninety','91':'ninety-one','92':'ninety-two','93':'ninety-three','94':'ninety-four','95':'ninety-five','96':'ninety-six','97':'ninety-seven','98':'ninety-eight','99':'ninety-nine'
    };
    const W1 = ['zero','one','two','three','four','five','six','seven','eight','nine'];
    if (n < 10) return `${W1[n]} points.`;
    if (n < 100) return `${W2[String(n).padStart(2,'0')]} points.`;
    const s4 = String(n).padStart(4,'0');
    const a = s4.slice(0,2);
    const b = s4.slice(2);
    const partA = (a === '00') ? '' : W2[a];
    const partB = (b === '00') ? '' : W2[b];
    const phrase = [partA, partB].filter(Boolean).join(' ');
    return `${phrase || 'zero'} points.`;
  }
  async function speakResult(score, {lang='en-US'}={}){
    if (!('speechSynthesis' in window)) return;
    if (!speechReady) {
      await unlockSpeech();
      if (!speechReady) { setTimeout(()=>{ if (speechReady) speakResult(score,{lang}); }, 80); return; }
    }
    const voices = await getVoicesAsync();
    const v = pickPreferredEnFemale(voices);
    const isExcellent = Number(score) >= 7000;
    const formatted = formatScoreTwoDigits(Number(score));
    const text = isExcellent ? `Excellent! ${formatted}` : formatted;
    try{
      if (lastUtter) { try{ speechSynthesis.cancel(); }catch(e){} }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang   = 'en-US';
      utter.rate   = 1.0;
      utter.pitch  = 2;
      utter.volume = 1.0;
      if (v) utter.voice = v;
      lastUtter = utter;
      speechSynthesis.speak(utter);
    }catch(e){ console.warn('TTS failed:', e); }
  }

  // === Voice (or beep) countdown ===
  const USE_VOICE_COUNTDOWN = true; // ビープに戻す場合は false
  const FAST_DIGITS = false; // digits not used now         // 3/2/1 を早口＆短尺に

// BURST の喋る速さ（1.0=標準。早くしたいなら 1.15〜1.35 あたり）
const BURST_RATE = 1.15;

// === Settings: real-time stability display ===
// 練習用は true、本番/大会用は false（終了後のみ表示）
const LIVE_STABILITY = false;


// 音声で言えたら true、ダメならビープにフォールバックして false を返す
function speakCountdown(label){
  return new Promise(async (resolve)=>{
    const fallback = ()=>{
      // フォールバックは短いビープ
      const tone = (label==='BURST!') ? 72 : 60;
      ensureAudio().then(()=>{ try{ beep(tone, label==='BURST!'?127:110); }catch(_){} });
      resolve(false);
    };

    if (!USE_VOICE_COUNTDOWN || !('speechSynthesis' in window)) { fallback(); return; }

    try{
      await unlockSpeech(); // iOS 対策：ユーザー操作後にアンロック
      const voices = await getVoicesAsync();
      const v = pickPreferredEnFemale(voices);

      const u = new SpeechSynthesisUtterance(String(label).replace('BURST!','Burst'));
      u.lang   = 'en-US';
      u.rate   = (label==='BURST!') ? BURST_RATE : 1.0;  // ← ここで速さ
      u.pitch  = 2;
      u.volume = 1.0;
      if (v) u.voice = v;

      let started = false;
      u.onstart = ()=>{ started = true; };
      u.onerror = ()=>{ fallback(); };
      u.onend   = ()=>{ resolve(true); };

      // 直前に話していたらだけ cancel（無闇に cancel すると失敗する端末がある）
      try{ if (speechSynthesis.speaking) speechSynthesis.cancel(); }catch(_){}
      speechSynthesis.speak(u);

      // iOS/Safari で start が来なかったときの保険（声が出なければビープへ）
      setTimeout(()=>{ if (!started) fallback(); }, 450);
    }catch(e){
      fallback();
    }
  });
}

// READY→BURST! だけ。BURST 言い終わり（onend）で startRun()
function startCountdown(){
  if (running || counting) return;
  counting = true;
  resetStats();
  document.body.classList.add('playing');

  const overlay = document.getElementById('overlay');
  overlay.classList.add('show');

  (async ()=>{
    overlay.textContent = 'READY';
    await speakCountdown('READY');     // READY は onend 待ち

    overlay.textContent = 'BURST!';
    await speakCountdown('BURST!');    // BURST 言い終わりで開始
    if (!counting) return;

    overlay.classList.remove('show');
    overlay.textContent = '';
    counting = false;
    startRun();
  })();
}


  // ===== Game loop =====
  let timerId=null, endAt=0;
const DUR_MS = 10000;                 // 10s window (for scoring calc)
const TARGET_HITS_10S = 200;          // target hits in 10s -> 100% speed (tweakable)
  function startRun(){
    running=true; btnStop.disabled=false; btnStart.disabled=true; ts.length=0; lastAccepted=null; ensureAudio();
    const DURATION=DUR_MS; // 10s
    const t0=performance.now(); endAt=t0+DURATION;
    const tick=()=>{
      const now=performance.now();
      const left=Math.max(0, endAt-now);
      elTime.textContent=(left/1000).toFixed(2);
      if (left<=0){ finish(); return; }
      timerId=requestAnimationFrame(tick);
    };
    timerId=requestAnimationFrame(tick);
  }
  // ===== Scoring (Hits + Stability bonus) =====
const SC_HITS_W = 1.0;      // weight for raw hits
const SC_STAB_W = 1.0;      // weight for stability bonus (relative to hits)
const SC_STAB_REF = 0.12;   // reference CV (lower is better). 0.12 ≈ very安定
function calcScore(){
  const hits = Number(elHits.textContent)|0;
  const effectiveHits = (mode==='E') ? hits : Math.floor(hits/2)*2; // trill counts by pairs
  // CV → bonus: if CV <= SC_STAB_REF, full bonus; if larger, bonus shrinks to 0
  const cv = calcStability();
  const stabFactor = Math.max(0, (SC_STAB_REF - cv)) / SC_STAB_REF; // 0..1
  const stabBonus = Math.round(effectiveHits * stabFactor * SC_STAB_W);
  const base = Math.round(effectiveHits * SC_HITS_W);
  return Math.max(0, base + stabBonus);
}
  function finish(){
    if(timerId){ cancelAnimationFrame(timerId); timerId=null; }
    running=false; counting=false; btnStop.disabled=true; btnStart.disabled=false; body.classList.remove('playing');

    // === Original-style scoring ===
    const N = ts.length;
    const dur = (ts.length>=1? (Math.max(1, (ts.at(-1) - ts[0]))/1000) : 0);
    const sec = Math.min(DUR_MS/1000, Math.max(0.001, dur));
    const hps = N / sec; // hits per second over effective duration

    // update SPEED if element exists (some builds removed it)
    const elSpeed = document.getElementById('speed');
    if (elSpeed) elSpeed.textContent = hps.toFixed(2);

    if(N>=2){
      const dt=[]; for(let i=1;i<N;i++) dt.push(ts[i]-ts[i-1]);
      const mu = dt.reduce((a,b)=>a+b,0)/dt.length;
      const sd = Math.sqrt(dt.reduce((s,x)=>s+(x-mu)*(x-mu),0)/dt.length);
      const stab = Math.max(0, Math.min(1, 1 - (sd/(mu||1))));
      elStab.textContent = stab.toFixed(3);

      const speedScore = Math.max(0, Math.min(100, (N / TARGET_HITS_10S) * 100));
      const stabScore  = stab * 100;
      scoreNum = Math.round(speedScore * stabScore);
      renderScore();
    }else{
      elStab.textContent = '0.000';
      scoreNum = 0; renderScore();
    }

    speakResult(scoreNum||0);
    resetKeyVisuals();
  }

  // ===== Tap logic =====
  function noteFromPos(evt){
    const r = area.getBoundingClientRect();
    const x = (evt.clientX ?? (evt.touches && evt.touches[0] && evt.touches[0].clientX) ?? r.left);
    const ratio = (x - r.left) / Math.max(1, r.width);
    return (ratio < 0.5) ? 60 : 62; // left:C(60), right:D(62)
  }
  function tapToNote(evt){
    const n = noteFromPos(evt);
    if (mode==='E'){
      if (n!==60) return null; // C のみ
    } else if (mode==='D'){
      if (lastAccepted===n) return null; // トリル（交互）
    }
    return { note:n };
  }

  function onDown(evt){
    if(!running) return;
    const res = tapToNote(evt);
    if(!res) return;
    lastAccepted = res.note;
    ts.push(performance.now());
    // HITS only; score is computed at finish
    elHits.textContent = String(Number(elHits.textContent)+1);
    if (LIVE_STABILITY) updateStability();
    // Visual & beep
    setKeyVisual(res.note, true);
    ensureAudio().then(()=>beep(res.note, 115));
  }
  function onUp(evt){
    if(!running) return;
    // どちらのキーか再判定して戻す（左右どちらでもOK）
    const n = noteFromPos(evt);
    setKeyVisual(n, false);
  }
  area.addEventListener('pointerdown', onDown);
  window.addEventListener('pointerup', onUp);

  // Buttons
  btnStart.addEventListener('click', ()=> startCountdown());
  btnStop .addEventListener('click', ()=> finish());


  // ==== iOS Safari: prevent tap-zoom & dblclick zoom ====
  (function preventIOSZoom(){
    const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    if(!isiOS) return;

    // 連続タップの二発目でのズームを抑止
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouchEnd <= 350) { e.preventDefault(); }
      lastTouchEnd = now;
    }, {passive:false});

    // dblclick ズームも殺す
    document.addEventListener('dblclick', (e)=>{ e.preventDefault(); }, {capture:true});

    // フォーカス時の自動ズームを避けるため、念のため 16px 未満の label/button に上書き
    document.querySelectorAll('label, button').forEach(el=>{
      const fs = parseFloat(getComputedStyle(el).fontSize);
      if (fs && fs < 16) el.style.fontSize = '16px';
    });
  })();


  // ===== Developer tests =====
  (function runDevTests(){
    if(!/[?&]test=1\b/.test(location.search)) return;
    console.log('[tests] start');
    const r = area.getBoundingClientRect ? area.getBoundingClientRect() : {left:0,width:100};
    // E mode: only C accepted
    mode='E'; lastAccepted=null;
    console.assert((tapToNote({clientX:r.left+0.1*r.width, pressure:1})||{}).note===60, 'E:C left ok');
    console.assert(tapToNote({clientX:r.left+0.9*r.width, pressure:1})===null, 'E:D right ignored');
    // D mode: alternate required
    mode='D'; lastAccepted=60;
    console.assert(tapToNote({clientX:r.left+0.1*r.width, pressure:1})===null, 'D:C repeat ignored');
    lastAccepted=60; console.assert((tapToNote({clientX:r.left+0.9*r.width, pressure:1})||{}).note===62, 'D:D accepted after C');
    // noteFromPos helper
    const nn = noteFromPos({clientX:r.left+0.75*r.width});
    console.assert(nn===62, 'noteFromPos right→D');
    console.log('[tests] ok');
  })();
  </script>
</body>
</html>
